<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompty V2 - æ ¸å¿ƒæ¨¡å—æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status.pending {
            background: #ffd93d;
            color: #856404;
        }

        .status.running {
            background: #4facfe;
            color: #004085;
        }

        .status.success {
            background: #6bcf7f;
            color: #155724;
        }

        .status.error {
            background: #ff6b6b;
            color: #721c24;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: all 0.2s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .log-entry.info { color: #4fc3f7; }
        .log-entry.success { color: #66bb6a; }
        .log-entry.error { color: #ef5350; }
        .log-entry.warn { color: #ffa726; }

        .result-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .result-box pre {
            margin: 0;
            overflow-x: auto;
            font-size: 12px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Prompty V2 - æ ¸å¿ƒæ¨¡å—æµ‹è¯•</h1>
        <p class="subtitle">Phase 1: åŸºç¡€è®¾æ–½éªŒè¯</p>

        <!-- æµ‹è¯•1: æ•°æ®åº“åˆå§‹åŒ– -->
        <div class="test-section">
            <h2>1. æ•°æ®åº“åˆå§‹åŒ– <span class="status pending" id="status-db">å¾…æµ‹è¯•</span></h2>
            <button onclick="testDatabase()" id="btn-db">è¿è¡Œæµ‹è¯•</button>
            <div class="progress-bar" id="progress-db" style="display:none;">
                <div class="progress-fill" id="progress-fill-db"></div>
            </div>
            <div class="log" id="log-db" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•2: Tree-sitterè§£æå™¨ -->
        <div class="test-section">
            <h2>2. Tree-sitterè§£æå™¨ <span class="status pending" id="status-parser">å¾…æµ‹è¯•</span></h2>
            <button onclick="testParser()" id="btn-parser" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-parser" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•3: è¯­ä¹‰æ ‡è®°æ³¨å…¥ -->
        <div class="test-section">
            <h2>3. è¯­ä¹‰æ ‡è®°æ³¨å…¥ <span class="status pending" id="status-marker">å¾…æµ‹è¯•</span></h2>
            <button onclick="testMarkerInjection()" id="btn-marker" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-marker" style="display:none;"></div>
            <div class="result-box" id="result-marker" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•4: ç‰ˆæœ¬ç®¡ç† -->
        <div class="test-section">
            <h2>4. ç‰ˆæœ¬ç®¡ç† <span class="status pending" id="status-version">å¾…æµ‹è¯•</span></h2>
            <button onclick="testVersionManager()" id="btn-version" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-version" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•5: å®Œæ•´æµç¨‹ -->
        <div class="test-section">
            <h2>5. å®Œæ•´æµç¨‹æµ‹è¯• <span class="status pending" id="status-full">å¾…æµ‹è¯•</span></h2>
            <button onclick="testFullWorkflow()" id="btn-full" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-full" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•6: ç´¢å¼•æ„å»ºæµ‹è¯• -->
        <div class="test-section">
            <h2>6. ç´¢å¼•æ„å»ºæµ‹è¯• <span class="status pending" id="status-indexer">å¾…æµ‹è¯•</span></h2>
            <button onclick="testIndexBuilder()" id="btn-indexer" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-indexer" style="display:none;"></div>
            <div class="result-box" id="result-indexer" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•7: è‡ªç„¶è¯­è¨€æŸ¥è¯¢æµ‹è¯• -->
        <div class="test-section">
            <h2>7. è‡ªç„¶è¯­è¨€æŸ¥è¯¢æµ‹è¯• <span class="status pending" id="status-nlp">å¾…æµ‹è¯•</span></h2>
            <button onclick="testNLPQuery()" id="btn-nlp" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-nlp" style="display:none;"></div>
            <div class="result-box" id="result-nlp" style="display:none;"></div>
        </div>

        <hr style="margin: 40px 0; border: none; border-top: 2px solid #ddd;">
        <p class="subtitle">Phase 2: é«˜çº§ä»£ç å®šä½ä¸ LLM é›†æˆ</p>

        <!-- æµ‹è¯•8: Tree-sitter Query æµ‹è¯• -->
        <div class="test-section">
            <h2>8. Tree-sitter Query æµ‹è¯• <span class="status pending" id="status-tsquery">å¾…æµ‹è¯•</span></h2>
            <button onclick="testTreeSitterQuery()" id="btn-tsquery" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-tsquery" style="display:none;"></div>
            <div class="result-box" id="result-tsquery" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•9: LLM æ„å›¾æå–æµ‹è¯•ï¼ˆéœ€è¦ API Keyï¼‰ -->
        <div class="test-section">
            <h2>9. LLM æ„å›¾æå–æµ‹è¯• <span class="status pending" id="status-llm-intent">å¾…æµ‹è¯•</span></h2>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #666;">OpenRouter API Key (å¯é€‰):</label>
                <input type="password" id="apikey-input" placeholder="sk-or-v1-..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #999; display: block; margin-top: 5px;">
                    â„¹ï¸ ä¸æä¾› API Key å°†ä½¿ç”¨è§„åˆ™åŒ¹é…ï¼ˆé€Ÿåº¦å¿«ä½†å‡†ç¡®åº¦è¾ƒä½ï¼‰
                </small>
            </div>
            <button onclick="testLLMIntent()" id="btn-llm-intent" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-llm-intent" style="display:none;"></div>
            <div class="result-box" id="result-llm-intent" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•10: å®Œæ•´ LLM æŸ¥è¯¢æµç¨‹ï¼ˆéœ€è¦ API Keyï¼‰ -->
        <div class="test-section">
            <h2>10. å®Œæ•´ LLM æŸ¥è¯¢æµç¨‹ <span class="status pending" id="status-llm-full">å¾…æµ‹è¯•</span></h2>
            <button onclick="testLLMFullWorkflow()" id="btn-llm-full" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-llm-full" style="display:none;"></div>
            <div class="result-box" id="result-llm-full" style="display:none;"></div>
        </div>

        <hr style="margin: 40px 0; border: none; border-top: 2px solid #ddd;">
        <p class="subtitle">Phase 3: æ‰¹é‡ä»£ç ä¿®æ”¹å¼•æ“</p>

        <!-- æµ‹è¯•11: ä»£ç ä¿®æ”¹å¼•æ“æµ‹è¯• -->
        <div class="test-section">
            <h2>11. ä»£ç ä¿®æ”¹å¼•æ“æµ‹è¯• <span class="status pending" id="status-mod-engine">å¾…æµ‹è¯•</span></h2>
            <button onclick="testModificationEngine()" id="btn-mod-engine" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-mod-engine" style="display:none;"></div>
            <div class="result-box" id="result-mod-engine" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•12: äº‹åŠ¡ç®¡ç†æµ‹è¯• -->
        <div class="test-section">
            <h2>12. äº‹åŠ¡ç®¡ç†æµ‹è¯• <span class="status pending" id="status-transaction">å¾…æµ‹è¯•</span></h2>
            <button onclick="testTransactionManager()" id="btn-transaction" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-transaction" style="display:none;"></div>
            <div class="result-box" id="result-transaction" style="display:none;"></div>
        </div>

        <!-- æµ‹è¯•13: å®Œæ•´ä¿®æ”¹æµç¨‹æµ‹è¯• -->
        <div class="test-section">
            <h2>13. å®Œæ•´ä¿®æ”¹æµç¨‹æµ‹è¯• <span class="status pending" id="status-full-mod">å¾…æµ‹è¯•</span></h2>
            <button onclick="testFullModificationWorkflow()" id="btn-full-mod" disabled>è¿è¡Œæµ‹è¯•</button>
            <div class="log" id="log-full-mod" style="display:none;"></div>
            <div class="result-box" id="result-full-mod" style="display:none;"></div>
        </div>
    </div>

    <!-- åŠ è½½æ ¸å¿ƒæ¨¡å— -->
    <script type="module">
        // ç”±äºä½¿ç”¨äº†ESæ¨¡å—ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        import { PGlite } from 'https://cdn.jsdelivr.net/npm/@electric-sql/pglite/dist/index.js';
        window.PGlite = PGlite;

        // æ—¥å¿—è¾…åŠ©å‡½æ•°
        window.log = function(testId, message, type = 'info') {
            const logDiv = document.getElementById(`log-${testId}`);
            logDiv.style.display = 'block';

            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        window.setStatus = function(testId, status) {
            const statusSpan = document.getElementById(`status-${testId}`);
            statusSpan.className = `status ${status}`;
            statusSpan.textContent = {
                pending: 'å¾…æµ‹è¯•',
                running: 'è¿è¡Œä¸­...',
                success: 'âœ“ é€šè¿‡',
                error: 'âœ— å¤±è´¥'
            }[status];
        };

        window.enableButton = function(testId) {
            document.getElementById(`btn-${testId}`).disabled = false;
        };

        // å…¨å±€å˜é‡
        let dbManager, parserManager, markerInjector, versionManager, indexBuilder, nlpEngine;
        let testVersionId; // ç”¨äºå­˜å‚¨æµ‹è¯•ç‰ˆæœ¬ID
        let tsQueryExecutor, queryPatternLibrary, intentTranslator;
        let llmClient, llmIntentExtractor, llmDisambiguator;
        let modEngine, transactionManager, dependencyResolver, diffGenerator, previewGenerator;

        // æµ‹è¯•1: æ•°æ®åº“åˆå§‹åŒ–
        window.testDatabase = async function() {
            const testId = 'db';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;
            document.getElementById(`progress-${testId}`).style.display = 'block';

            try {
                log(testId, 'å¼€å§‹åˆå§‹åŒ–PGliteæ•°æ®åº“...', 'info');

                // åˆ›å»ºDatabaseManagerå®ä¾‹
                dbManager = new DatabaseManager();

                // è¿›åº¦: 20%
                document.getElementById('progress-fill-db').style.width = '20%';
                log(testId, 'åˆ›å»ºDatabaseManagerå®ä¾‹æˆåŠŸ', 'success');

                // åˆå§‹åŒ–æ•°æ®åº“
                await dbManager.init();

                // è¿›åº¦: 60%
                document.getElementById('progress-fill-db').style.width = '60%';
                log(testId, 'æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ', 'success');

                // æµ‹è¯•æŸ¥è¯¢
                const result = await dbManager.query('SELECT COUNT(*) as count FROM versions');
                log(testId, `ç‰ˆæœ¬è¡¨æŸ¥è¯¢æˆåŠŸï¼Œå½“å‰æœ‰ ${result.rows[0].count} ä¸ªç‰ˆæœ¬`, 'success');

                // è¿›åº¦: 100%
                document.getElementById('progress-fill-db').style.width = '100%';

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

                // å¯ç”¨ä¸‹ä¸€ä¸ªæµ‹è¯•
                enableButton('parser');
                enableButton('marker');
                enableButton('version');
                enableButton('full');
                enableButton('indexer');
                enableButton('nlp');
                enableButton('tsquery');
                enableButton('llm-intent');
                enableButton('llm-full');
                enableButton('mod-engine');
                enableButton('transaction');
                enableButton('full-mod');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•2: Tree-sitterè§£æå™¨
        window.testParser = async function() {
            const testId = 'parser';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹åˆå§‹åŒ–Tree-sitterè§£æå™¨...', 'info');

                parserManager = new TreeSitterParser();
                await parserManager.init();

                log(testId, 'Tree-sitteråˆå§‹åŒ–æˆåŠŸ', 'success');

                // æµ‹è¯•HTMLè§£æ
                const htmlCode = '<div class="test"><p>Hello World</p></div>';
                log(testId, 'æµ‹è¯•HTMLè§£æ...', 'info');

                const tree = await parserManager.parse(htmlCode, 'html');
                log(testId, `HTMLè§£ææˆåŠŸï¼Œæ ¹èŠ‚ç‚¹ç±»å‹: ${tree.rootNode.type}`, 'success');

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•3: è¯­ä¹‰æ ‡è®°æ³¨å…¥
        window.testMarkerInjection = async function() {
            const testId = 'marker';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯•è¯­ä¹‰æ ‡è®°æ³¨å…¥...', 'info');

                markerInjector = new SemanticMarkerInjector();

                const htmlBefore = `
                    <html>
                        <body>
                            <nav><a href="index.html">é¦–é¡µ</a></nav>
                            <button class="btn-primary">è´­ä¹°</button>
                            <h1>æ ‡é¢˜</h1>
                        </body>
                    </html>
                `;

                log(testId, 'æ³¨å…¥è¯­ä¹‰æ ‡è®°...', 'info');
                const htmlAfter = markerInjector.injectMarkers(htmlBefore);

                log(testId, 'æå–è¯­ä¹‰æ ‡è®°...', 'info');
                const markers = markerInjector.extractMarkers(htmlAfter);

                log(testId, `æˆåŠŸæå– ${markers.length} ä¸ªè¯­ä¹‰æ ‡è®°`, 'success');

                // æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<pre>${JSON.stringify(markers, null, 2)}</pre>`;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•4: ç‰ˆæœ¬ç®¡ç†
        window.testVersionManager = async function() {
            const testId = 'version';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯•ç‰ˆæœ¬ç®¡ç†...', 'info');

                versionManager = new VersionManager(dbManager);

                // åˆ›å»ºæ–°ç‰ˆæœ¬
                log(testId, 'åˆ›å»ºæ–°ç‰ˆæœ¬...', 'info');
                const newVersion = await versionManager.createVersion(
                    'æµ‹è¯•ç‰ˆæœ¬',
                    'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬'
                );

                log(testId, `æ–°ç‰ˆæœ¬åˆ›å»ºæˆåŠŸ: ${newVersion.version_id}`, 'success');

                // è·å–æ‰€æœ‰ç‰ˆæœ¬
                const allVersions = await versionManager.getAllVersions();
                log(testId, `è·å–æ‰€æœ‰ç‰ˆæœ¬æˆåŠŸï¼Œå…± ${allVersions.length} ä¸ªç‰ˆæœ¬`, 'success');

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•5: å®Œæ•´æµç¨‹
        window.testFullWorkflow = async function() {
            const testId = 'full';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...', 'info');

                // 1. åˆ›å»ºç‰ˆæœ¬
                log(testId, 'Step 1: åˆ›å»ºæ–°ç‰ˆæœ¬...', 'info');
                const version = await versionManager.createVersion(
                    'å®Œæ•´æµç¨‹æµ‹è¯•ç‰ˆæœ¬',
                    'ç”Ÿæˆä¸€ä¸ªç®€å•ç½‘ç«™'
                );
                log(testId, `âœ“ ç‰ˆæœ¬ ${version.version_id} åˆ›å»ºæˆåŠŸ`, 'success');

                // 2. æ³¨å…¥è¯­ä¹‰æ ‡è®°
                log(testId, 'Step 2: æ³¨å…¥è¯­ä¹‰æ ‡è®°...', 'info');
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                        <head><title>æµ‹è¯•é¡µé¢</title></head>
                        <body>
                            <nav class="main-nav">
                                <a href="index.html">é¦–é¡µ</a>
                                <a href="about.html">å…³äº</a>
                            </nav>
                            <h1>æ¬¢è¿</h1>
                            <button class="btn-primary">ç«‹å³è´­ä¹°</button>
                        </body>
                    </html>
                `;
                const markedHtml = markerInjector.injectMarkers(htmlContent);
                log(testId, 'âœ“ è¯­ä¹‰æ ‡è®°æ³¨å…¥æˆåŠŸ', 'success');

                // 3. ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“
                log(testId, 'Step 3: ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“...', 'info');
                await dbManager.query(`
                    INSERT INTO files (version_id, file_path, content, content_hash)
                    VALUES ($1, $2, $3, $4)
                `, [version.version_id, 'index.html', markedHtml, 'test-hash']);
                log(testId, 'âœ“ æ–‡ä»¶ä¿å­˜æˆåŠŸ', 'success');

                // 4. æŸ¥è¯¢æ–‡ä»¶
                log(testId, 'Step 4: æŸ¥è¯¢æ–‡ä»¶...', 'info');
                const files = await versionManager.getVersionFiles(version.version_id);
                log(testId, `âœ“ æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`, 'success');

                log(testId, 'âœ“ å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•6: ç´¢å¼•æ„å»ºæµ‹è¯•
        window.testIndexBuilder = async function() {
            const testId = 'indexer';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯•ç´¢å¼•æ„å»ºåŠŸèƒ½...', 'info');

                // 1. åˆ›å»º IndexBuilder
                log(testId, 'Step 1: åˆ›å»º IndexBuilder...', 'info');
                indexBuilder = new IndexBuilder(dbManager);
                log(testId, 'âœ“ IndexBuilder åˆ›å»ºæˆåŠŸ', 'success');

                // 2. åˆ›å»ºæµ‹è¯•ç‰ˆæœ¬
                log(testId, 'Step 2: åˆ›å»ºæµ‹è¯•ç‰ˆæœ¬...', 'info');
                const version = await versionManager.createVersion(
                    'ç´¢å¼•æµ‹è¯•ç‰ˆæœ¬',
                    'æµ‹è¯•ç´¢å¼•æ„å»ºåŠŸèƒ½'
                );
                testVersionId = version.version_id;
                log(testId, `âœ“ æµ‹è¯•ç‰ˆæœ¬åˆ›å»ºæˆåŠŸ: ${testVersionId}`, 'success');

                // 3. å‡†å¤‡æµ‹è¯•æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿè¯»å–ç¤ºä¾‹æ–‡ä»¶ï¼‰
                log(testId, 'Step 3: å‡†å¤‡æµ‹è¯•æ–‡ä»¶...', 'info');
                const sampleFiles = [
                    {
                        file_path: 'index.html',
                        content: `
                            <!DOCTYPE html>
                            <html>
                                <head><title>é¦–é¡µ</title></head>
                                <body>
                                    <nav class="main-navigation">
                                        <a href="index.html">é¦–é¡µ</a>
                                        <a href="about.html">å…³äº</a>
                                    </nav>
                                    <h1>æ¬¢è¿</h1>
                                    <button class="btn-primary">è´­ä¹°</button>
                                </body>
                            </html>
                        `
                    },
                    {
                        file_path: 'about.html',
                        content: `
                            <!DOCTYPE html>
                            <html>
                                <head><title>å…³äº</title></head>
                                <body>
                                    <nav class="main-navigation">
                                        <a href="index.html">é¦–é¡µ</a>
                                        <a href="about.html">å…³äº</a>
                                    </nav>
                                    <h1>å…³äºæˆ‘ä»¬</h1>
                                    <p>å›¢é˜Ÿä»‹ç»</p>
                                </body>
                            </html>
                        `
                    }
                ];

                // 4. ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“
                log(testId, 'Step 4: ä¿å­˜æ–‡ä»¶åˆ°æ•°æ®åº“...', 'info');
                const filesWithIds = [];
                for (const file of sampleFiles) {
                    const result = await dbManager.query(`
                        INSERT INTO files (version_id, file_path, content, content_hash)
                        VALUES ($1, $2, $3, $4)
                        RETURNING id
                    `, [testVersionId, file.file_path, file.content, 'test-hash-' + file.file_path]);

                    filesWithIds.push({
                        id: result.rows[0].id,
                        file_path: file.file_path,
                        content: file.content
                    });
                }
                log(testId, `âœ“ ${filesWithIds.length} ä¸ªæ–‡ä»¶ä¿å­˜æˆåŠŸ`, 'success');

                // 5. æ„å»ºç´¢å¼•
                log(testId, 'Step 5: æ„å»ºç´¢å¼•...', 'info');
                const indexResult = await indexBuilder.buildIndex(filesWithIds, testVersionId);
                log(testId, `âœ“ ç´¢å¼•æ„å»ºå®Œæˆï¼Œè€—æ—¶ ${indexResult.duration} ç§’`, 'success');

                // 6. è·å–ç´¢å¼•ç»Ÿè®¡
                log(testId, 'Step 6: è·å–ç´¢å¼•ç»Ÿè®¡...', 'info');
                const stats = await indexBuilder.getIndexStats(testVersionId);
                log(testId, `âœ“ ç´¢å¼•ç»Ÿè®¡: æ–‡ä»¶=${stats.files}, ASTèŠ‚ç‚¹=${stats.astNodes}, è¯­ä¹‰æ ‡è®°=${stats.semanticMarkers}, ä¾èµ–=${stats.dependencies}`, 'success');

                // 7. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯</h4>
                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•7: è‡ªç„¶è¯­è¨€æŸ¥è¯¢æµ‹è¯•
        window.testNLPQuery = async function() {
            const testId = 'nlp';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯•è‡ªç„¶è¯­è¨€æŸ¥è¯¢åŠŸèƒ½...', 'info');

                // 1. åˆ›å»º NLP å¼•æ“ï¼ˆä¸ä½¿ç”¨ LLMï¼‰
                log(testId, 'Step 1: åˆ›å»º NLP å¼•æ“...', 'info');
                nlpEngine = new NaturalLanguageQueryEngine(dbManager, null);
                log(testId, 'âœ“ NLP å¼•æ“åˆ›å»ºæˆåŠŸ', 'success');

                // 2. æµ‹è¯•æŸ¥è¯¢1: æŸ¥æ‰¾å¯¼èˆª
                log(testId, 'Step 2: æµ‹è¯•æŸ¥è¯¢ "æ‰¾åˆ°æ‰€æœ‰å¯¼èˆª"...', 'info');
                const query1 = await nlpEngine.parseAndQuery('æ‰¾åˆ°æ‰€æœ‰å¯¼èˆª', testVersionId);
                log(testId, `âœ“ æ‰¾åˆ° ${query1.results.length} ä¸ªå¯¼èˆªå…ƒç´ `, 'success');

                // 3. æµ‹è¯•æŸ¥è¯¢2: æŸ¥æ‰¾æŒ‰é’®
                log(testId, 'Step 3: æµ‹è¯•æŸ¥è¯¢ "æ‰¾åˆ°è´­ä¹°æŒ‰é’®"...', 'info');
                const query2 = await nlpEngine.parseAndQuery('æ‰¾åˆ°è´­ä¹°æŒ‰é’®', testVersionId);
                log(testId, `âœ“ æ‰¾åˆ° ${query2.results.length} ä¸ªæŒ‰é’®`, 'success');

                // 4. æµ‹è¯•æŸ¥è¯¢3: æŸ¥æ‰¾æ ‡é¢˜
                log(testId, 'Step 4: æµ‹è¯•æŸ¥è¯¢ "æ‰¾åˆ°æ‰€æœ‰æ ‡é¢˜"...', 'info');
                const query3 = await nlpEngine.parseAndQuery('æ‰¾åˆ°æ‰€æœ‰æ ‡é¢˜', testVersionId);
                log(testId, `âœ“ æ‰¾åˆ° ${query3.results.length} ä¸ªæ ‡é¢˜`, 'success');

                // 5. æµ‹è¯•æ„å›¾æå–
                log(testId, 'Step 5: æµ‹è¯•æ„å›¾æå–...', 'info');
                const intent = nlpEngine.extractIntentByRules('æŠŠæ‰€æœ‰é¡µé¢çš„å¯¼èˆªèƒŒæ™¯è‰²æ”¹æˆæ·±è“');
                log(testId, `âœ“ æ„å›¾è¯†åˆ«æˆåŠŸ: operation=${intent.operation}, confidence=${intent.confidence}`, 'success');

                // 6. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>æŸ¥è¯¢ç»“æœç¤ºä¾‹ï¼ˆæŸ¥æ‰¾å¯¼èˆªï¼‰</h4>
                    <pre>${JSON.stringify(query1.results.slice(0, 3), null, 2)}</pre>
                    <h4 style="margin-top: 20px;">æ„å›¾æå–ç¤ºä¾‹</h4>
                    <pre>${JSON.stringify(intent, null, 2)}</pre>
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•8: Tree-sitter Query æµ‹è¯•
        window.testTreeSitterQuery = async function() {
            const testId = 'tsquery';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯• Tree-sitter Query åŠŸèƒ½...', 'info');

                // 1. åˆ›å»º Tree-sitter Query æ‰§è¡Œå™¨
                log(testId, 'Step 1: åˆ›å»º Tree-sitter Query æ‰§è¡Œå™¨...', 'info');
                tsQueryExecutor = new TreeSitterQueryExecutor(parserManager, dbManager);
                log(testId, 'âœ“ Tree-sitter Query æ‰§è¡Œå™¨åˆ›å»ºæˆåŠŸ', 'success');

                // 2. åˆ›å»ºæ¨¡å¼åº“
                log(testId, 'Step 2: åˆ›å»ºæŸ¥è¯¢æ¨¡å¼åº“...', 'info');
                queryPatternLibrary = new QueryPatternLibrary();
                log(testId, 'âœ“ æŸ¥è¯¢æ¨¡å¼åº“åˆ›å»ºæˆåŠŸ', 'success');

                // 3. åˆ›å»ºæ„å›¾è½¬æ¢å™¨
                log(testId, 'Step 3: åˆ›å»ºæ„å›¾è½¬æ¢å™¨...', 'info');
                intentTranslator = new IntentToQueryTranslator(queryPatternLibrary);
                log(testId, 'âœ“ æ„å›¾è½¬æ¢å™¨åˆ›å»ºæˆåŠŸ', 'success');

                // 4. æµ‹è¯•æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®
                log(testId, 'Step 4: æµ‹è¯•æŸ¥è¯¢ - æŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®...', 'info');
                const buttonQuery = queryPatternLibrary.getPattern('html', 'all_buttons');
                const results = await tsQueryExecutor.executeQueryOnVersion(testVersionId, buttonQuery, 'html');

                let totalMatches = 0;
                for (const fileResult of results) {
                    totalMatches += fileResult.count;
                }

                log(testId, `âœ“ æ‰¾åˆ° ${totalMatches} ä¸ªæŒ‰é’®å…ƒç´ `, 'success');

                // 5. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>Tree-sitter Query æŸ¥è¯¢ç»“æœ</h4>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•9: LLM æ„å›¾æå–æµ‹è¯•
        window.testLLMIntent = async function() {
            const testId = 'llm-intent';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯• LLM æ„å›¾æå–åŠŸèƒ½...', 'info');

                // è·å– API Key
                const apiKey = document.getElementById('apikey-input').value.trim();

                if (!apiKey) {
                    log(testId, 'â„¹ï¸ æœªæä¾› API Keyï¼Œå°†ä½¿ç”¨è§„åˆ™åŒ¹é…', 'warn');
                } else {
                    log(testId, 'âœ“ ä½¿ç”¨ OpenRouter API Key', 'info');

                    // åˆ›å»º LLM å®¢æˆ·ç«¯
                    log(testId, 'Step 1: åˆ›å»º LLM å®¢æˆ·ç«¯...', 'info');
                    llmClient = new LLMClient(apiKey);
                    log(testId, 'âœ“ LLM å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');

                    // åˆ›å»º LLM æ„å›¾æå–å™¨
                    log(testId, 'Step 2: åˆ›å»º LLM æ„å›¾æå–å™¨...', 'info');
                    llmIntentExtractor = new LLMIntentExtractor(llmClient);
                    log(testId, 'âœ“ LLM æ„å›¾æå–å™¨åˆ›å»ºæˆåŠŸ', 'success');

                    // æµ‹è¯•æ„å›¾æå–
                    log(testId, 'Step 3: æµ‹è¯•æ„å›¾æå–...', 'info');
                    const testInput = "æŠŠæ‰€æœ‰é¡µé¢çš„å¯¼èˆªæ èƒŒæ™¯è‰²æ”¹æˆæ·±è“è‰²";
                    const intent = await llmIntentExtractor.extractIntent(testInput);

                    log(testId, `âœ“ æ„å›¾æå–æˆåŠŸï¼Œç½®ä¿¡åº¦: ${intent.confidence}`, 'success');

                    // æ˜¾ç¤ºç»“æœ
                    const resultDiv = document.getElementById(`result-${testId}`);
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <h4>LLM æ„å›¾æå–ç»“æœ</h4>
                        <p><strong>è¾“å…¥:</strong> ${testInput}</p>
                        <pre>${JSON.stringify(intent, null, 2)}</pre>
                        <h4 style="margin-top: 20px;">LLM ç»Ÿè®¡</h4>
                        <pre>${JSON.stringify(llmClient.getStats(), null, 2)}</pre>
                    `;
                }

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•10: å®Œæ•´ LLM æŸ¥è¯¢æµç¨‹
        window.testLLMFullWorkflow = async function() {
            const testId = 'llm-full';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹å®Œæ•´ LLM æŸ¥è¯¢æµç¨‹æµ‹è¯•...', 'info');

                // æ£€æŸ¥æ˜¯å¦æœ‰ LLM å®¢æˆ·ç«¯
                if (!llmClient) {
                    log(testId, 'â„¹ï¸ æœªæä¾› API Keyï¼Œæµ‹è¯•å°†ä½¿ç”¨è§„åˆ™åŒ¹é…', 'warn');
                }

                // 1. åˆ›å»ºå¢å¼ºçš„ NLP å¼•æ“
                log(testId, 'Step 1: åˆ›å»ºå¢å¼ºçš„ NLP å¼•æ“...', 'info');
                const enhancedNLP = new NaturalLanguageQueryEngine(
                    dbManager,
                    llmClient,
                    tsQueryExecutor,
                    intentTranslator,
                    llmIntentExtractor
                );
                log(testId, 'âœ“ å¢å¼ºçš„ NLP å¼•æ“åˆ›å»ºæˆåŠŸ', 'success');

                // 2. æµ‹è¯•æŸ¥è¯¢
                log(testId, 'Step 2: æµ‹è¯•å¤æ‚æŸ¥è¯¢...', 'info');
                const testQuery = "æ‰¾åˆ°é¦–é¡µçš„è´­ä¹°æŒ‰é’®";
                const queryResult = await enhancedNLP.parseAndQuery(testQuery, testVersionId);

                log(testId, `âœ“ æŸ¥è¯¢å®Œæˆï¼Œæ‰¾åˆ° ${queryResult.results.length} ä¸ªåŒ¹é…`, 'success');
                log(testId, `âœ“ ä½¿ç”¨äº† ${queryResult.strategies.length} ä¸ªç­–ç•¥`, 'success');

                // 3. æµ‹è¯•å¤šåŒ¹é…å¤„ç†ï¼ˆå¦‚æœæœ‰ LLMï¼‰
                if (llmClient && queryResult.results.length > 1) {
                    log(testId, 'Step 3: æµ‹è¯• LLM æ¶ˆæ­§...', 'info');

                    llmDisambiguator = new LLMDisambiguator(llmClient);
                    const multiMatchHandler = new MultiMatchHandler(llmClient, llmDisambiguator);

                    const strategy = await multiMatchHandler.handleMultipleMatches(
                        queryResult.results,
                        queryResult.intent,
                        testQuery
                    );

                    log(testId, `âœ“ æ¶ˆæ­§å®Œæˆï¼Œç­–ç•¥: ${strategy.type}`, 'success');
                    log(testId, `âœ“ é€‰æ‹©äº† ${strategy.selectedMatches.length} ä¸ªåŒ¹é…`, 'success');
                }

                // 4. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>å®Œæ•´æŸ¥è¯¢æµç¨‹ç»“æœ</h4>
                    <p><strong>æŸ¥è¯¢:</strong> ${testQuery}</p>
                    <p><strong>ç­–ç•¥æ•°:</strong> ${queryResult.strategies.length}</p>
                    <p><strong>åŒ¹é…æ•°:</strong> ${queryResult.results.length}</p>
                    <h4 style="margin-top: 20px;">åŒ¹é…ç»“æœ</h4>
                    <pre>${JSON.stringify(queryResult.results.slice(0, 3), null, 2)}</pre>
                    ${llmClient ? `
                    <h4 style="margin-top: 20px;">LLM ç»Ÿè®¡</h4>
                    <pre>${JSON.stringify(llmClient.getStats(), null, 2)}</pre>
                    ` : ''}
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•11: ä»£ç ä¿®æ”¹å¼•æ“æµ‹è¯•
        window.testModificationEngine = async function() {
            const testId = 'mod-engine';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯•ä»£ç ä¿®æ”¹å¼•æ“...', 'info');

                // 1. åˆ›å»ºä¿®æ”¹å¼•æ“
                log(testId, 'Step 1: åˆ›å»ºä¿®æ”¹å¼•æ“...', 'info');
                modEngine = new CodeModificationEngine(dbManager, parserManager);
                log(testId, 'âœ“ ä¿®æ”¹å¼•æ“åˆ›å»ºæˆåŠŸ', 'success');

                // 2. åˆ›å»ºä¿®æ”¹æ“ä½œ
                log(testId, 'Step 2: åˆ›å»ºä¿®æ”¹æ“ä½œ...', 'info');
                const modification = new ModificationBuilder()
                    .target('index.html', 'nav')
                    .setStyle({
                        background: '#001f3f',
                        color: '#ffffff'
                    })
                    .build();

                modEngine.addModification(modification);
                log(testId, 'âœ“ ä¿®æ”¹æ“ä½œå·²æ·»åŠ åˆ°é˜Ÿåˆ—', 'success');

                // 3. æ˜¾ç¤ºå¾…å¤„ç†ä¿®æ”¹
                const stats = modEngine.getStats();
                log(testId, `âœ“ å½“å‰æœ‰ ${stats.pending} ä¸ªå¾…å¤„ç†ä¿®æ”¹`, 'success');

                // 4. åˆ›å»ºæ‰¹é‡ä¿®æ”¹è¾…åŠ©å™¨
                log(testId, 'Step 3: æµ‹è¯•æ‰¹é‡ä¿®æ”¹è¾…åŠ©å™¨...', 'info');
                const batchHelper = new BatchModificationHelper(modEngine);
                log(testId, 'âœ“ æ‰¹é‡ä¿®æ”¹è¾…åŠ©å™¨åˆ›å»ºæˆåŠŸ', 'success');

                // 5. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>ä¿®æ”¹å¼•æ“çŠ¶æ€</h4>
                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                    <h4 style="margin-top: 20px;">å¾…å¤„ç†ä¿®æ”¹</h4>
                    <pre>${JSON.stringify(modEngine.pendingModifications, null, 2)}</pre>
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•12: äº‹åŠ¡ç®¡ç†æµ‹è¯•
        window.testTransactionManager = async function() {
            const testId = 'transaction';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹æµ‹è¯•äº‹åŠ¡ç®¡ç†...', 'info');

                // 1. åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨
                log(testId, 'Step 1: åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨...', 'info');
                transactionManager = new TransactionManager(dbManager, indexBuilder);
                log(testId, 'âœ“ äº‹åŠ¡ç®¡ç†å™¨åˆ›å»ºæˆåŠŸ', 'success');

                // 2. åˆ›å»ºä¾èµ–è§£æå™¨
                log(testId, 'Step 2: åˆ›å»ºä¾èµ–è§£æå™¨...', 'info');
                dependencyResolver = new DependencyResolver(dbManager);
                log(testId, 'âœ“ ä¾èµ–è§£æå™¨åˆ›å»ºæˆåŠŸ', 'success');

                // 3. åˆ›å»ºå·®å¼‚ç”Ÿæˆå™¨
                log(testId, 'Step 3: åˆ›å»ºå·®å¼‚ç”Ÿæˆå™¨...', 'info');
                diffGenerator = new DiffGenerator(dbManager);
                previewGenerator = new PreviewGenerator(diffGenerator);
                log(testId, 'âœ“ å·®å¼‚ç”Ÿæˆå™¨åˆ›å»ºæˆåŠŸ', 'success');

                // 4. å¼€å§‹äº‹åŠ¡
                log(testId, 'Step 4: å¼€å§‹äº‹åŠ¡...', 'info');
                const transaction = await transactionManager.beginTransaction('æµ‹è¯•äº‹åŠ¡');
                log(testId, `âœ“ äº‹åŠ¡åˆ›å»ºæˆåŠŸ: ${transaction.id}`, 'success');

                // 5. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>äº‹åŠ¡ä¿¡æ¯</h4>
                    <pre>${JSON.stringify(transaction, null, 2)}</pre>
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // æµ‹è¯•13: å®Œæ•´ä¿®æ”¹æµç¨‹æµ‹è¯•
        window.testFullModificationWorkflow = async function() {
            const testId = 'full-mod';
            setStatus(testId, 'running');
            document.getElementById(`btn-${testId}`).disabled = true;

            try {
                log(testId, 'å¼€å§‹å®Œæ•´ä¿®æ”¹æµç¨‹æµ‹è¯•...', 'info');

                // 1. æŸ¥è¯¢è¦ä¿®æ”¹çš„å…ƒç´ 
                log(testId, 'Step 1: æŸ¥è¯¢å¯¼èˆªå…ƒç´ ...', 'info');
                const queryResult = await nlpEngine.parseAndQuery('æ‰¾åˆ°æ‰€æœ‰å¯¼èˆª', testVersionId);
                log(testId, `âœ“ æ‰¾åˆ° ${queryResult.results.length} ä¸ªå¯¼èˆªå…ƒç´ `, 'success');

                // 2. åˆ›å»ºæ‰¹é‡ä¿®æ”¹
                log(testId, 'Step 2: åˆ›å»ºæ‰¹é‡ä¿®æ”¹...', 'info');
                const batchHelper = new BatchModificationHelper(modEngine);
                const modifications = await batchHelper.applyStyleToAll(queryResult.results, {
                    background: '#001f3f',
                    color: '#ffffff',
                    padding: '15px'
                });
                log(testId, `âœ“ åˆ›å»ºäº† ${modifications.length} ä¸ªä¿®æ”¹æ“ä½œ`, 'success');

                // 3. åˆ†æå½±å“èŒƒå›´
                log(testId, 'Step 3: åˆ†æå½±å“èŒƒå›´...', 'info');
                const impact = await dependencyResolver.resolveImpact(modifications, testVersionId);
                log(testId, `âœ“ å½±å“ ${impact.directFiles.size} ä¸ªæ–‡ä»¶`, 'success');

                // 4. ç”Ÿæˆé¢„è§ˆ
                log(testId, 'Step 4: ç”Ÿæˆä¿®æ”¹é¢„è§ˆ...', 'info');
                const textPreview = previewGenerator.generateTextPreview(testVersionId, modifications);
                log(testId, 'âœ“ é¢„è§ˆç”ŸæˆæˆåŠŸ', 'success');

                // 5. æ˜¾ç¤ºç»“æœ
                const resultDiv = document.getElementById(`result-${testId}`);
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <h4>æŸ¥è¯¢ç»“æœ</h4>
                    <p>æ‰¾åˆ° ${queryResult.results.length} ä¸ªå¯¼èˆªå…ƒç´ </p>

                    <h4 style="margin-top: 20px;">ä¿®æ”¹æ“ä½œ</h4>
                    <p>åˆ›å»ºäº† ${modifications.length} ä¸ªä¿®æ”¹</p>

                    <h4 style="margin-top: 20px;">å½±å“èŒƒå›´</h4>
                    <p>ç›´æ¥å½±å“: ${impact.directFiles.size} ä¸ªæ–‡ä»¶</p>
                    <p>é—´æ¥å½±å“: ${impact.dependentFiles.size} ä¸ªæ–‡ä»¶</p>
                    ${impact.suggestions.length > 0 ? `
                    <p>å»ºè®®: ${impact.suggestions.length} æ¡</p>
                    ` : ''}

                    <h4 style="margin-top: 20px;">ä¿®æ”¹é¢„è§ˆ</h4>
                    <pre style="font-size: 11px;">${textPreview}</pre>
                `;

                log(testId, 'âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
                log(testId, 'â„¹ï¸ å®é™…åº”ç”¨ä¿®æ”¹è¯·æŸ¥çœ‹åç»­çš„é›†æˆæµ‹è¯•', 'info');
                setStatus(testId, 'success');

            } catch (error) {
                log(testId, `âœ— æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
                setStatus(testId, 'error');
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            console.log('[Test] æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            console.log('[Test] è¯·ç‚¹å‡»"è¿è¡Œæµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>

    <!-- åŠ è½½æ ¸å¿ƒæ¨¡å—ï¼ˆéæ¨¡å—æ–¹å¼ï¼‰ -->
    <script src="core-modules.js"></script>
    <script src="indexer-modules.js"></script>
    <script src="nlp-query-engine.js"></script>
    <script src="tree-sitter-query-executor.js"></script>
    <script src="llm-client.js"></script>
    <script src="code-modification-engine.js"></script>
    <script src="transaction-manager.js"></script>
    <script src="diff-generator.js"></script>
</body>
</html>
