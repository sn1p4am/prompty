<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæç¤ºè¯æ‰¹é‡æµ‹è¯•å·¥å…·</title>
    <!-- Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Mermaid å›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <!-- ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/es/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --error-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --card-bg: rgba(255, 255, 255, 0.1);
            --card-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --border-radius: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 255, 198, 0.2) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œç•™å‡ºè¾¹è· */
            width: 90%; /* ä½¿ç”¨90%çš„å±å¹•å®½åº¦ï¼Œä¸¤è¾¹ç•™5%é—´è· */
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header-actions {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-actions-left {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-primary);
            cursor: help;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1001;
        }

        .version-badge:hover {
            background: rgba(102, 126, 234, 0.25);
            transform: translateY(-1px);
        }

        .version-badge svg {
            width: 14px;
            height: 14px;
        }

        .version-tooltip {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 20px;
            min-width: 320px;
            max-width: 450px;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10000;
            font-size: 13px;
            line-height: 1.7;
            text-align: left;
        }

        .version-badge:hover .version-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .version-tooltip h4 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .version-tooltip ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
            color: var(--text-secondary);
        }

        .version-tooltip li {
            margin: 8px 0;
            padding-left: 0;
            line-height: 1.6;
            text-align: left;
        }

        .version-tooltip li:first-child {
            margin-top: 0;
        }

        .version-tooltip li:last-child {
            margin-bottom: 0;
        }

        .version-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 20px;
            width: 12px;
            height: 12px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--card-border);
            border-top: 1px solid var(--card-border);
            transform: rotate(45deg);
            z-index: 10001;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header h1 .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header h1 .emoji-icon {
            display: inline-block;
            margin-right: 8px;
        }

        .controls {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .prompt-section {
            margin-bottom: 20px;
        }

        .prompt-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .prompt-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting-label {
            font-weight: 600;
            font-size: 13px;
        }

        .select-input, .number-input {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .select-input option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        .select-input option:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .select-input option:disabled {
            color: var(--text-secondary);
            font-style: italic;
            background: var(--bg-primary);
        }

        .select-input:focus, .number-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .model-select-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn-icon {
            padding: 8px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .add-model-dialog {
            margin-top: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 8px;
        }

        .api-key-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        .api-key-section.hidden {
            display: none;
        }

        .api-key-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(40, 167, 69, 0.15);
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .api-key-badge:hover {
            background: rgba(40, 167, 69, 0.25);
            transform: translateY(-1px);
        }

        .api-key-badge svg {
            width: 14px;
            height: 14px;
        }

        .models-link-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .models-link-badge:hover {
            background: rgba(102, 126, 234, 0.25);
            transform: translateY(-1px);
        }

        .models-link-badge svg {
            width: 14px;
            height: 14px;
        }

        .api-key-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .api-key-input {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            color: var(--text-primary);
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
        }

        .api-key-status {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-icon.success {
            background: #28a745;
        }

        .status-icon.warning {
            background: #ffc107;
        }

        .add-model-input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            margin-bottom: 10px;
        }

        .dialog-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-small {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-small.btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-small.btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--card-border);
        }

        .btn-small:hover {
            transform: translateY(-1px);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7b8ef7 0%, #8a5cb8 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #f66b7e 0%, #f2a3fc 100%);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .stats .stat-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stats .stat-value {
            font-size: 42px;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .stats .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            margin-top: 4px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* é»˜è®¤5åˆ—å¸ƒå±€ */
            gap: 15px;
            width: 100%;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 700px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            width: 100%; /* å¼ºåˆ¶å®½åº¦ç”±gridæ§åˆ¶ */
            min-width: 0; /* å…è®¸æ”¶ç¼©ï¼Œé˜²æ­¢æº¢å‡º */
            height: 420px; /* å›ºå®šé«˜åº¦ */
            min-height: 420px; /* æœ€å°é«˜åº¦ */
            max-height: 420px; /* æœ€å¤§é«˜åº¦ */
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .card-header {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--card-border);
            flex-shrink: 0;
        }

        .card-header-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
        }

        .provider-info {
            font-size: 10px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .model-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            color: var(--text-primary);
            display: block;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: flex-start;
            white-space: nowrap;
        }

        .status-waiting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-generating {
            background: rgba(0, 123, 255, 0.2);
            color: #007bff;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .status-error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .card-content {
            flex: 1 1 0; /* å æ®å‰©ä½™ç©ºé—´ï¼Œå¯æ”¶ç¼©å¯æ‰©å±•ï¼ŒåŸºå‡†ä¸º0 */
            min-height: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼©åˆ°å†…å®¹ä»¥ä¸‹ */
            overflow-y: auto; /* å†…å®¹è¿‡é•¿æ—¶æ»šåŠ¨ */
            overflow-x: hidden; /* éšè—æ¨ªå‘æ»šåŠ¨ */
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 10px;
            padding-right: 5px;
            word-wrap: break-word;
            word-break: break-word; /* å¼ºåˆ¶é•¿å•è¯æ¢è¡Œ */
            white-space: pre-wrap; /* ä¿ç•™åŸå§‹æ ¼å¼ */
            scrollbar-width: thin;
            scrollbar-color: var(--card-border) transparent;
        }

        /* Markdown æ¸²æŸ“æ ·å¼ */
        .card-content.markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .card-content.markdown-body h1,
        .card-content.markdown-body h2,
        .card-content.markdown-body h3 {
            margin-top: 12px;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.25;
        }

        .card-content.markdown-body h1 { font-size: 1.4em; border-bottom: 1px solid var(--card-border); padding-bottom: 4px; }
        .card-content.markdown-body h2 { font-size: 1.2em; }
        .card-content.markdown-body h3 { font-size: 1.1em; }

        .card-content.markdown-body p {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .card-content.markdown-body code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .card-content.markdown-body pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .card-content.markdown-body pre code {
            background: none;
            padding: 0;
        }

        .card-content.markdown-body ul,
        .card-content.markdown-body ol {
            margin: 8px 0;
            padding-left: 24px;
        }

        .card-content.markdown-body li {
            margin: 4px 0;
        }

        .card-content.markdown-body blockquote {
            border-left: 3px solid var(--card-border);
            padding-left: 12px;
            margin: 8px 0;
            color: var(--text-secondary);
        }

        .card-content.markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
        }

        .card-content.markdown-body table th,
        .card-content.markdown-body table td {
            border: 1px solid var(--card-border);
            padding: 6px 10px;
            text-align: left;
        }

        .card-content.markdown-body table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }

        .card-content.markdown-body a {
            color: #4facfe;
            text-decoration: none;
        }

        .card-content.markdown-body a:hover {
            text-decoration: underline;
        }

        /* Mermaid å›¾è¡¨æ ·å¼ */
        .card-content.markdown-body .mermaid {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            text-align: center;
        }

        .card-content::-webkit-scrollbar {
            width: 6px;
        }

        .card-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .card-content::-webkit-scrollbar-thumb {
            background: var(--card-border);
            border-radius: 3px;
        }

        .card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 10px;
            line-height: 1.2;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼© */
            flex-grow: 0; /* é˜²æ­¢æ‰©å±• */
            height: 62px; /* å›ºå®šé«˜åº¦ */
            min-height: 62px; /* å›ºå®šæœ€å°é«˜åº¦ */
            max-height: 62px; /* å›ºå®šæœ€å¤§é«˜åº¦ */
            opacity: 0; /* åˆå§‹éšè—ï¼Œä½†å æ®ç©ºé—´ */
            transition: opacity 0.3s ease; /* æ·¡å…¥æ•ˆæœ */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        .card-stats.visible {
            opacity: 1; /* å¯è§çŠ¶æ€ */
        }

        .card-stats .stat-item {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .card-stats .stat-label {
            color: var(--text-secondary);
            font-size: 9px;
            font-weight: 400;
            opacity: 0.7;
        }

        .card-stats .stat-value {
            color: var(--text-primary);
            font-size: 10px;
            font-weight: 600;
            font-family: 'Monaco', 'Courier New', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Native tokens æ ‡è®° */
        .stat-label:after {
            content: attr(data-native);
            color: #4CAF50;
            font-size: 8px;
            vertical-align: super;
            margin-left: 2px;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .card-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .card-btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .card-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--card-border);
        }

        .card-btn:hover {
            transform: translateY(-1px);
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--card-border);
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 2% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        #modalContent {
            font-size: 14px;
            line-height: 1.8;
        }

        #modalContent.raw-view {
            white-space: pre-wrap;
            font-family: 'Monaco', 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
        }

        #modalContent.markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        #modalContent.markdown-body h1,
        #modalContent.markdown-body h2,
        #modalContent.markdown-body h3 {
            margin-top: 20px;
            margin-bottom: 12px;
            font-weight: 600;
            line-height: 1.25;
        }

        #modalContent.markdown-body h1 { font-size: 2em; border-bottom: 2px solid var(--card-border); padding-bottom: 8px; }
        #modalContent.markdown-body h2 { font-size: 1.5em; }
        #modalContent.markdown-body h3 { font-size: 1.25em; }

        #modalContent.markdown-body p {
            margin-top: 0;
            margin-bottom: 16px;
        }

        #modalContent.markdown-body code {
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        #modalContent.markdown-body pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }

        #modalContent.markdown-body pre code {
            background: none;
            padding: 0;
        }

        #modalContent.markdown-body ul,
        #modalContent.markdown-body ol {
            margin: 12px 0;
            padding-left: 32px;
        }

        #modalContent.markdown-body li {
            margin: 6px 0;
        }

        #modalContent.markdown-body blockquote {
            border-left: 4px solid var(--card-border);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
        }

        #modalContent.markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }

        #modalContent.markdown-body table th,
        #modalContent.markdown-body table td {
            border: 1px solid var(--card-border);
            padding: 10px 16px;
            text-align: left;
        }

        #modalContent.markdown-body table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }

        #modalContent.markdown-body a {
            color: #4facfe;
            text-decoration: none;
        }

        #modalContent.markdown-body a:hover {
            text-decoration: underline;
        }

        #modalContent.markdown-body .mermaid {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
        }

        /* ============================================
         * HTML å†…å®¹æ¸²æŸ“ä¼˜åŒ–ï¼ˆå…¼å®¹å¤šç§ Markdown æ¥æºï¼‰
         * æ³¨ï¼šä¼˜åŒ–è¿‡çš„ AI æç¤ºè¯ä¼šæ˜¾å¼å£°æ˜æ‰€æœ‰é¢œè‰²ï¼Œ
         * ä»¥ä¸‹è§„åˆ™ä¸»è¦ä½œä¸ºå…œåº•å®¹é”™æœºåˆ¶
         * ============================================ */

        /* 1. å­—ä½“å®¶æ—ä¼˜åŒ– - æ·»åŠ ä¸­æ–‡å­—ä½“æ”¯æŒ */
        #modalContent.markdown-body div[style],
        .card-content.markdown-body div[style] {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
        }

        #modalContent.markdown-body div[style] h1,
        #modalContent.markdown-body div[style] h2,
        #modalContent.markdown-body div[style] h3,
        #modalContent.markdown-body div[style] h4,
        #modalContent.markdown-body div[style] h5,
        #modalContent.markdown-body div[style] h6,
        .card-content.markdown-body div[style] h1,
        .card-content.markdown-body div[style] h2,
        .card-content.markdown-body div[style] h3,
        .card-content.markdown-body div[style] h4,
        .card-content.markdown-body div[style] h5,
        .card-content.markdown-body div[style] h6 {
            font-family: inherit;
            font-weight: 600;
        }

        /* 2. è¡Œé«˜ä¼˜åŒ– */
        #modalContent.markdown-body div[style] p,
        .card-content.markdown-body div[style] p {
            line-height: 1.6;
        }

        /* 3. é¢œè‰²å…œåº•è§„åˆ™ï¼ˆå®¹é”™æœºåˆ¶ï¼‰
         * é€‚ç”¨åœºæ™¯ï¼šæ‰‹å†™ Markdownã€å…¶ä»–å·¥å…·ç”Ÿæˆã€æ—§ç‰ˆå†…å®¹ç­‰
         * ä¼˜å…ˆçº§ï¼šä½äºæ˜¾å¼å£°æ˜çš„é¢œè‰² */

        /* 3.1 æ”¯æŒé¢œè‰²ç»§æ‰¿ï¼ˆé€‚ç”¨äºæœªæ˜¾å¼å£°æ˜é¢œè‰²çš„å…ƒç´ ï¼‰ */
        #modalContent.markdown-body [style*="color"]:not([style*="background"]) *:not([style*="color"]),
        .card-content.markdown-body [style*="color"]:not([style*="background"]) *:not([style*="color"]) {
            color: inherit;
        }

        /* 3.2 ç™½è‰²/æµ…è‰²èƒŒæ™¯å…œåº• - å¼ºåˆ¶æ·±è‰²æ–‡å­—ï¼ˆé¿å…ç™½åº•ç™½å­—ï¼‰ */
        #modalContent.markdown-body div[style*="background"][style*="white"] *:not([style*="color"]),
        #modalContent.markdown-body div[style*="background"][style*="#fff"] *:not([style*="color"]),
        .card-content.markdown-body div[style*="background"][style*="white"] *:not([style*="color"]),
        .card-content.markdown-body div[style*="background"][style*="#fff"] *:not([style*="color"]) {
            color: #333 !important;
        }

        /* HTML é¢„è§ˆæ ·å¼ */
        #modalContent.html-preview {
            background: white;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            min-height: 400px;
        }

        #modalContent.html-preview iframe {
            width: 100%;
            min-height: 500px;
            border: none;
            background: white;
        }

        /* HTML é¢„è§ˆè­¦å‘Šä¿¡æ¯ */
        .html-preview-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #ffc107;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .html-preview-warning svg {
            flex-shrink: 0;
        }

        /* HTML æˆªæ–­è­¦å‘Š */
        .html-truncated-warning {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #f44336;
            font-size: 13px;
        }

        .modal-header {
            position: sticky;
            top: -30px;
            z-index: 10;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: -30px -30px 20px -30px;
            padding: 30px 30px 15px 30px;
            border-bottom: 1px solid var(--card-border);
        }

        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--text-secondary);
        }

        .view-toggle-btn.active {
            background: var(--primary-gradient);
            color: white;
        }

        .view-toggle-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--text-primary);
        }


        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .error-details {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%; /* ç§»åŠ¨è®¾å¤‡ä½¿ç”¨å…¨å®½ */
                width: 100%; /* ç§»åŠ¨è®¾å¤‡ä½¿ç”¨å…¨å®½ */
                padding: 10px;
            }

            .settings-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }

        .typing-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }

        .typing-indicator:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* AIç”Ÿå›¾åŠŸèƒ½æ ·å¼ */
        .image-gen-container {
            padding: 20px 0;
        }

        .generated-images-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .generated-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .generated-image-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .generated-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .generated-image-item img:hover {
            transform: scale(1.05);
        }

        .generated-image-item .image-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 15px 10px 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .generated-image-item:hover .image-actions {
            opacity: 1;
        }

        .image-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .image-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        @media (max-width: 1200px) {
            .generated-images-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .generated-images-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .generated-images-grid {
                grid-template-columns: 1fr;
            }
        }

        /* å›¾ç‰‡é¢„è§ˆModalæ ·å¼ */
        .image-preview-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
        }

        .image-preview-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-preview-content img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .image-preview-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.2s ease;
        }

        .image-preview-close:hover {
            transform: scale(1.1);
            color: #f5576c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-actions-left">
                <button class="models-link-badge" onclick="openImageGenModal()" title="AIå›¾ç‰‡ç”Ÿæˆ" style="border: none; background: rgba(240, 147, 251, 0.15); border: 1px solid rgba(240, 147, 251, 0.3);">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                    </svg>
                    <span>AIç”Ÿå›¾</span>
                </button>
            </div>
            <div class="header-actions">
                <a href="models.html" class="models-link-badge" title="æŸ¥çœ‹æ¨¡å‹å‚æ•°ä¸ä»·æ ¼">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 3h18v2H3V3zm0 4h18v2H3V7zm0 4h18v2H3v-2zm0 4h18v2H3v-2zm0 4h18v2H3v-2z"/>
                    </svg>
                    <span>æ¨¡å‹å‚æ•°</span>
                </a>
                <div class="version-badge">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    <span>v2.3.0</span>
                    <div class="version-tooltip">
                        <h4>
                            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            v2.3.0 æ›´æ–°å†…å®¹
                        </h4>
                        <ul>
                            <li>âœ¨ æ–°å¢ AI å›¾ç‰‡ç”ŸæˆåŠŸèƒ½ï¼ˆTogether AI FLUX.1-schnellï¼‰</li>
                            <li>ğŸ¨ ä¸€é”®ç”Ÿæˆ 4 å¼  1024Ã—1024 é«˜è´¨é‡å›¾ç‰‡</li>
                            <li>ğŸ’¾ æ”¯æŒå›¾ç‰‡ç›´æ¥ä¸‹è½½ä¿å­˜</li>
                            <li>ğŸ” API Key ä½¿ç”¨ localStorage å®‰å…¨å­˜å‚¨</li>
                        </ul>
                    </div>
                </div>
                <div id="apiKeyBadge" class="api-key-badge" onclick="editApiKey()" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.65 10A5.99 5.99 0 0 0 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 0 0 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    </svg>
                    <span id="apiKeyBadgeText">API Key</span>
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                </div>
            </div>
            <h1><span class="emoji-icon">ğŸ¤–</span> <span class="gradient-text">AIæç¤ºè¯æ‰¹é‡æµ‹è¯•å·¥å…·</span></h1>
            <p>ä½¿ç”¨å¤šä¸ªAIæ¨¡å‹åŒæ—¶æµ‹è¯•æ‚¨çš„æç¤ºè¯æ•ˆæœ</p>
        </div>

        <div class="controls">
            <div class="api-key-section" id="apiKeySection">
                <label class="prompt-label">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
                        <path d="M12.65 10A5.99 5.99 0 0 0 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 0 0 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                    </svg>
                    OpenRouter API Key
                </label>
                <div class="api-key-input-wrapper">
                    <input type="password" id="apiKeyInput" class="api-key-input" placeholder="sk-or-v1-..." onkeypress="if(event.key==='Enter') saveApiKey()">
                    <button type="button" class="btn-small btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
                    <button type="button" class="btn-small btn-secondary" onclick="clearApiKey()">æ¸…é™¤</button>
                </div>
                <div class="api-key-status" id="apiKeyStatus">
                    <span class="status-icon warning"></span>
                    <span>è¯·è¾“å…¥æ‚¨çš„ OpenRouter API Key</span>
                </div>
            </div>

            <div class="prompt-section">
                <label class="prompt-label" for="promptInput">æç¤ºè¯å†…å®¹</label>
                <textarea id="promptInput" class="prompt-input" placeholder="è¯·è¾“å…¥æ‚¨è¦æµ‹è¯•çš„æç¤ºè¯...&#10;æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œå¯ä»¥åŒ…å«å¤æ‚çš„æŒ‡ä»¤å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚"></textarea>
            </div>

            <div class="settings-grid">
                <div class="setting-group">
                    <label class="setting-label">è¯·æ±‚æ•°</label>
                    <select id="batchSize" class="select-input">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label class="setting-label">é—´éš”(ms)</label>
                    <input type="number" id="requestInterval" class="number-input" value="500" min="0" max="5000" step="100">
                </div>

                <div class="setting-group">
                    <label class="setting-label">å¹¶å‘æ•°</label>
                    <input type="number" id="maxConcurrent" class="number-input" value="3" min="1" max="20">
                </div>

                <div class="setting-group">
                    <label class="setting-label">Temperature</label>
                    <input type="number" id="temperature" class="number-input" value="1" min="0" max="2" step="0.1">
                </div>

                <div class="setting-group">
                    <label class="setting-label">Top-p</label>
                    <input type="number" id="topP" class="number-input" value="1" min="0" max="1" step="0.05">
                </div>

                <div class="setting-group">
                    <label class="setting-label">å“åº”æ¨¡å¼</label>
                    <select id="streamMode" class="select-input">
                        <option value="true" selected>æµå¼</option>
                        <option value="false">éæµå¼</option>
                    </select>
                </div>

                <div class="setting-group" style="grid-column: span 2;">
                    <label class="setting-label">é€‰æ‹©æ¨¡å‹</label>
                    <div class="model-select-wrapper">
                        <select id="modelSelect" class="select-input" onchange="onModelSelectChange()">
                            <!-- æ¨¡å‹é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <button type="button" class="btn-icon" onclick="toggleAddModelDialog()" title="æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="addModelDialog" class="add-model-dialog" style="display: none;">
                        <input type="text" id="newModelInput" class="add-model-input" placeholder="è¾“å…¥æ¨¡å‹ID (å¦‚: openai/gpt-4)">
                        <div class="dialog-actions">
                            <button type="button" class="btn-small btn-primary" onclick="confirmAddModel()">ç¡®å®š</button>
                            <button type="button" class="btn-small btn-secondary" onclick="toggleAddModelDialog()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="action-buttons">
                <button id="startBtn" class="btn btn-primary" onclick="startBatchTest()">
                    ğŸš€ å¼€å§‹ç”Ÿæˆ
                </button>
                <button id="stopBtn" class="btn btn-danger" onclick="stopAllRequests()" disabled>
                    â¹ åœæ­¢æ‰€æœ‰
                </button>
            </div>

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="stats" id="statsSection">
            <div class="stat-item">
                <div class="stat-value" id="totalRequests">0</div>
                <div class="stat-label">æ€»è¯·æ±‚</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="successRequests">0</div>
                <div class="stat-label">æˆåŠŸ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="failedRequests">0</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgTime">0s</div>
                <div class="stat-label">å¹³å‡è€—æ—¶</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activeRequests">0</div>
                <div class="stat-label">è¿›è¡Œä¸­</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalCostStat">$0.00</div>
                <div class="stat-label">æ€»è´¹ç”¨</div>
            </div>
        </div>

        <div class="results-grid" id="resultsGrid">
            <!-- ç»“æœå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å…¨å±æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h3 id="modalTitle">å“åº”è¯¦æƒ…</h3>
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" onclick="toggleModalView('raw')">åŸå§‹å†…å®¹</button>
                        <button class="view-toggle-btn" onclick="toggleModalView('markdown')">Markdown é¢„è§ˆ</button>
                        <button class="view-toggle-btn" onclick="toggleModalView('html')">HTML é¢„è§ˆ</button>
                    </div>
                </div>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent" class="raw-view"></div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imagePreviewModal" class="image-preview-modal" onclick="closeImagePreview()">
        <span class="image-preview-close">&times;</span>
        <div class="image-preview-content">
            <img id="imagePreviewImg" src="" alt="å›¾ç‰‡é¢„è§ˆ">
        </div>
    </div>

    <!-- AIç”Ÿå›¾æ¨¡æ€æ¡† -->
    <div id="imageGenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¨ AI å›¾ç‰‡ç”Ÿæˆ</h3>
                <span class="close" onclick="closeImageGenModal()">&times;</span>
            </div>
            <div class="image-gen-container">
                <!-- API Key å¾½ç« ï¼ˆå·²é…ç½®æ—¶æ˜¾ç¤ºï¼‰ -->
                <div style="margin-bottom: 20px;">
                    <div id="togetherApiKeyBadge" class="api-key-badge" onclick="editTogetherApiKey()" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.65 10A5.99 5.99 0 0 0 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 0 0 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                        </svg>
                        <span id="togetherApiKeyBadgeText">API Key</span>
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </div>
                </div>

                <!-- API Key é…ç½®åŒºåŸŸ -->
                <div class="api-key-section" id="togetherApiKeySection">
                    <label class="prompt-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
                            <path d="M12.65 10A5.99 5.99 0 0 0 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6a5.99 5.99 0 0 0 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                        </svg>
                        Together AI API Key
                    </label>
                    <div class="api-key-input-wrapper">
                        <input type="password" id="togetherApiKeyInput" class="api-key-input" placeholder="è¾“å…¥æ‚¨çš„ Together AI API Key" onkeypress="if(event.key==='Enter') saveTogetherApiKey()">
                        <button type="button" class="btn-small btn-primary" onclick="saveTogetherApiKey()">ä¿å­˜</button>
                        <button type="button" class="btn-small btn-secondary" onclick="clearTogetherApiKey()">æ¸…é™¤</button>
                    </div>
                    <div class="api-key-status" id="togetherApiKeyStatus">
                        <span class="status-icon warning"></span>
                        <span>è¯·è¾“å…¥æ‚¨çš„ Together AI API Key</span>
                    </div>
                </div>

                <!-- æç¤ºè¯è¾“å…¥åŒºåŸŸ -->
                <div class="prompt-section">
                    <label class="prompt-label">å›¾ç‰‡ç”Ÿæˆæç¤ºè¯</label>
                    <textarea id="imagePromptInput" class="prompt-input" placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡..." style="min-height: 100px;"></textarea>
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="generateImageBtn" onclick="generateImages()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                        </svg>
                        <span>ç”Ÿæˆå›¾ç‰‡</span>
                    </button>
                </div>

                <!-- ç”ŸæˆçŠ¶æ€æ˜¾ç¤º -->
                <div id="imageGenStatus" style="display: none; text-align: center; margin: 20px 0; color: var(--text-secondary);">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...</p>
                </div>

                <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
                <div id="generatedImagesGrid" class="generated-images-grid">
                    <!-- ç”Ÿæˆçš„å›¾ç‰‡å°†åœ¨è¿™é‡Œå±•ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®å¸¸é‡
        const API_BASE_URL = 'https://openrouter.ai/api/v1';
        
        // ä» localStorage è·å– API Key
        function getApiKey() {
            return localStorage.getItem('openrouter_api_key') || '';
        }

        // å¯ç”¨æ¨¡å‹åˆ—è¡¨
        const AVAILABLE_MODELS = [
            'anthropic/claude-sonnet-4',
            'qwen/qwen3-max',
            'qwen/qwen3-coder-plus',
            'openai/gpt-5-codex',
            'deepseek/deepseek-v3.1-terminus',
            'moonshotai/kimi-k2-0905',
            'deepseek/deepseek-chat-v3.1'
        ];


        // å…¨å±€çŠ¶æ€
        let selectedModel = localStorage.getItem('last_selected_model') || 'anthropic/claude-sonnet-4';
        let activeRequests = new Map();
        let requestStats = {
            total: 0,
            success: 0,
            failed: 0,
            times: [],
            totalCost: 0,
            retries: 0,        // é‡è¯•æ¬¡æ•°ç»Ÿè®¡
            incomplete: 0      // ä¸å®Œæ•´å“åº”ç»Ÿè®¡
        };
        let requestQueue = [];
        let isRunning = false;

        // è‡ªå®šä¹‰æ¨¡å‹åˆ—è¡¨
        let customModels = [];

        // ä¿å­˜ API Key
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
                return;
            }
            
            if (!key.startsWith('sk-or-v1-')) {
                if (!confirm('API Key æ ¼å¼ä¼¼ä¹ä¸æ­£ç¡®ï¼ˆåº”ä»¥ sk-or-v1- å¼€å¤´ï¼‰ï¼Œæ˜¯å¦ä»è¦ä¿å­˜ï¼Ÿ')) {
                    return;
                }
            }
            
            localStorage.setItem('openrouter_api_key', key);
            updateApiKeyStatus();
            showToast('API Key å·²ä¿å­˜');
        }

        // æ¸…é™¤ API Key
        function clearApiKey() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤å·²ä¿å­˜çš„ API Key å—ï¼Ÿ')) {
                return;
            }
            
            localStorage.removeItem('openrouter_api_key');
            document.getElementById('apiKeyInput').value = '';
            updateApiKeyStatus();
            showToast('API Key å·²æ¸…é™¤');
        }

        // ç¼–è¾‘ API Key
        function editApiKey() {
            const section = document.getElementById('apiKeySection');
            section.classList.remove('hidden');
            document.getElementById('apiKeyInput').focus();
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // æ›´æ–° API Key çŠ¶æ€æ˜¾ç¤º
        function updateApiKeyStatus() {
            const key = getApiKey();
            const section = document.getElementById('apiKeySection');
            const badge = document.getElementById('apiKeyBadge');
            const badgeText = document.getElementById('apiKeyBadgeText');
            const status = document.getElementById('apiKeyStatus');
            const input = document.getElementById('apiKeyInput');
            
            if (key) {
                // éšè—é…ç½®åŒºåŸŸï¼Œæ˜¾ç¤ºå¾½ç« 
                section.classList.add('hidden');
                badge.style.display = 'inline-flex';
                badgeText.textContent = `${key.substring(0, 12)}...${key.substring(key.length - 4)}`;
                input.value = key;
            } else {
                // æ˜¾ç¤ºé…ç½®åŒºåŸŸï¼Œéšè—å¾½ç« 
                section.classList.remove('hidden');
                badge.style.display = 'none';
                status.innerHTML = `
                    <span class="status-icon warning"></span>
                    <span>è¯·è¾“å…¥æ‚¨çš„ OpenRouter API Keyï¼ˆ<a href="https://openrouter.ai/keys" target="_blank" style="color: #4facfe;">è·å– API Key</a>ï¼‰</span>
                `;
                input.value = '';
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomModels();
            initializeModelSelect();
            syncUserModels(); // åŒæ­¥æ¨¡å‹åˆ—è¡¨åˆ° localStorage
            updateApiKeyStatus();
            
            // åˆå§‹åŒ– Mermaid
            mermaid.initialize({ 
                startOnLoad: false,
                theme: 'dark',
                themeVariables: {
                    primaryColor: '#667eea',
                    primaryTextColor: '#fff',
                    primaryBorderColor: '#764ba2',
                    lineColor: '#667eea',
                    secondaryColor: '#f093fb',
                    tertiaryColor: '#4facfe'
                }
            });

            // é…ç½® marked
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {}
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
        });

        // åˆå§‹åŒ–æ¨¡å‹ä¸‹æ‹‰æ¡†
        function initializeModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';

            // æ·»åŠ é»˜è®¤æ¨¡å‹
            AVAILABLE_MODELS.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = formatModelName(model);
                if (model === selectedModel) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // æ·»åŠ è‡ªå®šä¹‰æ¨¡å‹
            if (customModels.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = 'â”€â”€â”€â”€ è‡ªå®šä¹‰æ¨¡å‹ â”€â”€â”€â”€';
                select.appendChild(separator);

                customModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = formatModelName(model) + ' (è‡ªå®šä¹‰)';
                    if (model === selectedModel) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        }

        // æ ¼å¼åŒ–æ¨¡å‹åç§°æ˜¾ç¤º
        function formatModelName(model) {
            const parts = model.split('/');
            if (parts.length === 2) {
                const provider = parts[0];
                const modelName = parts[1];
                const providerNames = {
                    'anthropic': 'Anthropic',
                    'openai': 'OpenAI',
                    'google': 'Google',
                    'deepseek': 'DeepSeek',
                    'qwen': 'Qwen',
                    'moonshotai': 'Moonshot',
                    'mistralai': 'Mistral'
                };
                const displayProvider = providerNames[provider] || provider;
                return `${displayProvider} - ${modelName}`;
            }
            return model;
        }

        // æ¨¡å‹é€‰æ‹©å˜åŒ–
        function onModelSelectChange() {
            const select = document.getElementById('modelSelect');
            selectedModel = select.value;
            // ä¿å­˜æœ€åé€‰æ‹©çš„æ¨¡å‹
            localStorage.setItem('last_selected_model', selectedModel);
        }

        // åˆ‡æ¢æ·»åŠ æ¨¡å‹å¯¹è¯æ¡†
        function toggleAddModelDialog() {
            const dialog = document.getElementById('addModelDialog');
            const input = document.getElementById('newModelInput');

            if (dialog.style.display === 'none') {
                dialog.style.display = 'block';
                input.value = '';
                input.focus();
            } else {
                dialog.style.display = 'none';
            }
        }

        // ç¡®è®¤æ·»åŠ æ¨¡å‹
        function confirmAddModel() {
            const input = document.getElementById('newModelInput');
            const modelId = input.value.trim();

            if (!modelId) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ¨¡å‹ID');
                return;
            }

            if (AVAILABLE_MODELS.includes(modelId) || customModels.includes(modelId)) {
                alert('è¯¥æ¨¡å‹å·²å­˜åœ¨');
                return;
            }

            // éªŒè¯æ¨¡å‹IDæ ¼å¼
            if (!modelId.includes('/')) {
                alert('æ¨¡å‹IDæ ¼å¼åº”ä¸º: provider/model-name');
                return;
            }

            customModels.push(modelId);
            saveCustomModels();
            selectedModel = modelId;
            initializeModelSelect();
            toggleAddModelDialog();
        }

        // ä¿å­˜è‡ªå®šä¹‰æ¨¡å‹åˆ°æœ¬åœ°å­˜å‚¨
        function saveCustomModels() {
            localStorage.setItem('customModels', JSON.stringify(customModels));
            // åŒæ­¥æ‰€æœ‰æ¨¡å‹ï¼ˆé»˜è®¤+è‡ªå®šä¹‰ï¼‰åˆ° user_modelsï¼Œä¾›æ¨¡å‹å‚æ•°é¡µé¢ä½¿ç”¨
            syncUserModels();
        }

        // åŒæ­¥ç”¨æˆ·æ¨¡å‹åˆ—è¡¨åˆ° localStorage
        function syncUserModels() {
            const allModels = [...AVAILABLE_MODELS, ...customModels];
            localStorage.setItem('user_models', JSON.stringify(allModels));
        }

        // åŠ è½½è‡ªå®šä¹‰æ¨¡å‹
        function loadCustomModels() {
            const saved = localStorage.getItem('customModels');
            if (saved) {
                customModels = JSON.parse(saved);
            }
        }


        // å¼€å§‹æ‰¹é‡æµ‹è¯•
        async function startBatchTest() {
            try {
                // æ£€æŸ¥ API Key
                const apiKey = getApiKey();
                if (!apiKey) {
                    alert('è¯·å…ˆé…ç½® OpenRouter API Key');
                    document.getElementById('apiKeyInput').focus();
                    return;
                }

                console.log('å¼€å§‹æ‰¹é‡æµ‹è¯•...');
                const prompt = document.getElementById('promptInput').value.trim();
                if (!prompt) {
                    alert('è¯·è¾“å…¥æç¤ºè¯å†…å®¹');
                    return;
                }

                console.log('é€‰ä¸­çš„æ¨¡å‹:', selectedModel);
                if (!selectedModel) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªæ¨¡å‹');
                    return;
                }
                
                // ä¿å­˜æœ€åé€‰æ‹©çš„æ¨¡å‹
                localStorage.setItem('last_selected_model', selectedModel);

                const batchSize = parseInt(document.getElementById('batchSize').value);
                const interval = parseInt(document.getElementById('requestInterval').value);
                const maxConcurrent = parseInt(document.getElementById('maxConcurrent').value);
                const temperature = parseFloat(document.getElementById('temperature').value);
                const topP = parseFloat(document.getElementById('topP').value);
                const streamMode = document.getElementById('streamMode').value === 'true';

                console.log('æ‰¹é‡å‚æ•°:', { batchSize, interval, maxConcurrent, temperature, topP });

            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('progressBar').style.display = 'block';

            // é‡ç½®ç»Ÿè®¡
            requestStats = { total: 0, success: 0, failed: 0, times: [], totalCost: 0, retries: 0, incomplete: 0 };

            // ç”Ÿæˆè¯·æ±‚é˜Ÿåˆ—
            requestQueue = [];
            for (let i = 0; i < batchSize; i++) {
                requestQueue.push({
                    id: generateId(),
                    model: selectedModel,
                    prompt,
                    index: i,
                    temperature,
                    topP,
                    streamMode
                });
            }

            requestStats.total = requestQueue.length;
            updateStats();

            // åˆ›å»ºç»“æœå¡ç‰‡
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            requestQueue.forEach(request => {
                const card = createResultCard(request);
                resultsGrid.appendChild(card);
            });

            // æ§åˆ¶å¹¶å‘æ‰§è¡Œ
            let activeCount = 0;
            let queueIndex = 0;

            async function processNext() {
                if (!isRunning || queueIndex >= requestQueue.length) return;

                while (activeCount < maxConcurrent && queueIndex < requestQueue.length) {
                    const request = requestQueue[queueIndex++];
                    activeCount++;
                    updateStats();

                    processRequest(request).finally(() => {
                        activeCount--;
                        if (interval > 0) {
                            setTimeout(processNext, interval);
                        } else {
                            processNext();
                        }
                    });

                    if (interval > 0 && activeCount < maxConcurrent) {
                        await new Promise(resolve => setTimeout(resolve, interval));
                    }
                }
            }

            processNext();
            } catch (error) {
                console.error('æ‰¹é‡æµ‹è¯•å¯åŠ¨å¤±è´¥:', error);
                alert('å¯åŠ¨å¤±è´¥: ' + error.message);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        // å¤„ç†å•ä¸ªè¯·æ±‚
        async function processRequest(request) {
            const card = document.getElementById(request.id);
            const contentDiv = card.querySelector('.card-content');
            const statusBadge = card.querySelector('.status-badge');

            try {
                updateCardStatus(card, 'generating');
                const startTime = Date.now();

                // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const TIMEOUT_MS = 120000; // 120ç§’è¶…æ—¶
                const timeoutId = setTimeout(() => {
                    console.warn(`è¯·æ±‚è¶…æ—¶ (${TIMEOUT_MS/1000}ç§’)ï¼Œä¸­æ­¢è¿æ¥`);
                    controller.abort();
                }, TIMEOUT_MS);

                // è°ƒè¯•: æ£€æŸ¥ API Key
                const apiKey = getApiKey();
                console.log('ğŸ”‘ ä½¿ç”¨çš„ API Key:', apiKey ? `${apiKey.substring(0, 20)}...` : '(ç©º)');

                const response = await fetch(`${API_BASE_URL}/chat/completions`, {
                    signal: controller.signal,
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://prompt-tester.app',
                        'X-Title': 'Prompt Tester'
                    },
                    body: JSON.stringify({
                        model: request.model,
                        messages: [{ role: 'user', content: request.prompt }],
                        stream: request.streamMode !== false,  // é»˜è®¤ä¸ºtrue
                        temperature: request.temperature || 1.0,
                        top_p: request.topP || 1,
                        // ä¸è®¾ç½® max_tokensï¼Œè®© OpenRouter é¢„è®¾è‡ªåŠ¨å¤„ç†
                        // å¦‚æœé¢„è®¾ä¸­æœªé…ç½®ï¼ŒOpenRouter ä¼šä½¿ç”¨ (æ¨¡å‹ä¸Šä¸‹æ–‡é•¿åº¦ - è¾“å…¥tokens) ä½œä¸ºå¯ç”¨ç©ºé—´
                        // æ³¨æ„ï¼šä¸åŒ provider å¯¹ max_tokens æœ‰ä¸åŒé™åˆ¶ï¼Œåº”åœ¨é¢„è®¾ä¸­æ ¹æ®å…·ä½“ provider é…ç½®åˆé€‚çš„å€¼
                        // æ ¹æ® OpenRouter æ–‡æ¡£ï¼Œå¿…é¡»æ˜¾å¼å¯ç”¨ usage accounting
                        usage: {
                            include: true
                        }
                    })
                });

                // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                clearTimeout(timeoutId);

                if (!response.ok) {
                    // å°è¯•è·å–è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.error('API é”™è¯¯è¯¦æƒ…:');
                        console.error('å®Œæ•´å“åº”:', JSON.stringify(errorData, null, 2));
                        if (errorData.error) {
                            console.error('é”™è¯¯å¯¹è±¡:', errorData.error);
                            console.error('é”™è¯¯æ¶ˆæ¯:', errorData.error.message);
                            console.error('é”™è¯¯ä»£ç :', errorData.error.code);
                            console.error('é”™è¯¯å…ƒæ•°æ®:', errorData.error.metadata);

                            // æå–æä¾›å•†çš„åŸå§‹é”™è¯¯
                            if (errorData.error.metadata?.raw) {
                                try {
                                    const providerError = JSON.parse(errorData.error.metadata.raw);
                                    console.error('ğŸ” æä¾›å•†åŸå§‹é”™è¯¯:', providerError.error?.message || providerError);
                                } catch (e) {}
                            }
                        }
                        console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                        // å°è¯•æå–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        let detailedError = errorData.error?.message || JSON.stringify(errorData);
                        if (errorData.error?.metadata?.raw) {
                            try {
                                const providerError = JSON.parse(errorData.error.metadata.raw);
                                if (providerError.error?.message) {
                                    detailedError = `${errorData.error.metadata.provider_name}: ${providerError.error.message}`;
                                }
                            } catch (e) {}
                        }
                        errorDetail = detailedError;
                    } catch (e) {
                        console.warn('æ— æ³•è§£æé”™è¯¯å“åº”ä½“');
                    }
                    throw new Error(`HTTP ${response.status}: ${errorDetail}`);
                }

                // è·å–å“åº”headersä¸­çš„providerä¿¡æ¯
                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key.toLowerCase()] = value;
                });

                let content = '';
                let provider = 'Routing...';
                let usage = null;
                let modelId = request.model;
                let actualProvider = null;
                let generationId = null;

                // éæµå¼æ¨¡å¼
                if (request.streamMode === false) {
                    const data = await response.json();
                    console.log('éæµå¼å“åº”:', data);

                    // è·å–å†…å®¹
                    content = data.choices?.[0]?.message?.content || '';
                    contentDiv.textContent = content;
                    contentDiv.setAttribute('data-raw-content', content);

                    // è·å–usage - éæµå¼æ¨¡å¼ç›´æ¥åŒ…å«åœ¨å“åº”ä¸­
                    usage = data.usage;
                    modelId = data.model || request.model;
                    generationId = data.id;

                    if (usage) {
                        console.log('éæµå¼æ¨¡å¼usage:', JSON.stringify(usage, null, 2));
                        console.log(`Token ç»Ÿè®¡ - è¾“å…¥: ${usage.prompt_tokens}, è¾“å‡º: ${usage.completion_tokens}, æ€»è®¡: ${usage.total_tokens}`);
                    } else {
                        console.warn('éæµå¼æ¨¡å¼æœªè¿”å› usage ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ API é…ç½®');
                    }
                }
                // æµå¼æ¨¡å¼
                else {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = ''; // ç¼“å†²åŒºï¼Œç”¨äºå¤„ç†è¢«åˆ†å‰²çš„æ•°æ®
                    let lastChunkTime = Date.now();
                    const CHUNK_TIMEOUT = 30000; // 30ç§’æ— æ•°æ®åˆ™è®¤ä¸ºè¶…æ—¶

                while (true) {
                    let done, value;
                    try {
                        // æ·»åŠ åˆ†å—è¶…æ—¶æ£€æµ‹
                        const readPromise = reader.read();
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => {
                                reject(new Error(`æµå¼è¯»å–è¶…æ—¶: ${CHUNK_TIMEOUT/1000}ç§’å†…æœªæ”¶åˆ°æ•°æ®`));
                            }, CHUNK_TIMEOUT);
                        });

                        ({ done, value } = await Promise.race([readPromise, timeoutPromise]));

                        if (done) {
                            console.log('æµå¼ä¼ è¾“æ­£å¸¸ç»“æŸ');
                            break;
                        }

                        lastChunkTime = Date.now();
                    } catch (readError) {
                        console.error('æµå¼è¯»å–é”™è¯¯:', readError);
                        // å¦‚æœæ˜¯è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å·²æœ‰å†…å®¹å¹¶æŠ›å‡ºé”™è¯¯
                        if (content) {
                            console.warn('å·²æ¥æ”¶éƒ¨åˆ†å†…å®¹ï¼Œä¿å­˜å¹¶æ ‡è®°ä¸ºä¸å®Œæ•´');
                            contentDiv.setAttribute('data-incomplete', 'true');
                        }
                        throw readError;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // ä¿ç•™æœ€åä¸€è¡Œï¼ˆå¯èƒ½ä¸å®Œæ•´ï¼‰

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6).trim();
                            if (data === '[DONE]') {
                                console.log('æµå¼ç»“æŸæ ‡è®°');
                                continue;
                            }
                            if (!data) continue;

                            try {
                                const json = JSON.parse(data);

                                // è·å–å®é™…ä½¿ç”¨çš„æ¨¡å‹ä¿¡æ¯
                                if (json.model) {
                                    modelId = json.model;
                                }

                                // å°è¯•ä»å“åº”ä¸­è·å–providerä¿¡æ¯
                                // OpenRouterå¯èƒ½åœ¨ä¸åŒå­—æ®µè¿”å›è¿™äº›ä¿¡æ¯
                                if (json.provider) {
                                    actualProvider = json.provider;
                                }

                                // æ£€æŸ¥æ˜¯å¦æœ‰ x_provider æˆ–å…¶ä»–providerä¿¡æ¯
                                if (json.x_provider) {
                                    actualProvider = json.x_provider;
                                }

                                // å¦‚æœæœ‰idå­—æ®µï¼Œå¯èƒ½åŒ…å«providerä¿¡æ¯
                                if (json.id && !actualProvider) {
                                    // OpenRouterçš„generation IDæ ¼å¼å¯èƒ½åŒ…å«providerä¿¡æ¯
                                    // ä¾‹å¦‚: "gen-azure-xxx" æˆ– "gen-bedrock-xxx"
                                    const idParts = json.id.split('-');
                                    if (idParts.length > 1 && idParts[0] === 'gen') {
                                        const possibleProvider = idParts[1];
                                        const knownProviders = ['azure', 'aws', 'bedrock', 'google', 'openai', 'anthropic', 'groq', 'together'];
                                        if (knownProviders.includes(possibleProvider.toLowerCase())) {
                                            actualProvider = possibleProvider;
                                        }
                                    }
                                }

                                // è·å–å¢é‡å†…å®¹
                                const delta = json.choices?.[0]?.delta?.content;
                                if (delta) {
                                    content += delta;
                                    // å¡ç‰‡ä¸­æ˜¾ç¤ºåŸå§‹å†…å®¹
                                    contentDiv.textContent = content;
                                    contentDiv.setAttribute('data-raw-content', content);
                                    contentDiv.scrollTop = contentDiv.scrollHeight;
                                }

                                                // è·å– generation IDï¼ˆç”¨äºåç»­æŸ¥è¯¢å‡†ç¡®çš„ native_tokensï¼‰
                                if (json.id) {
                                    generationId = json.id;
                                    console.log('Generation ID:', generationId);
                                }

                                // è·å– usage ä¿¡æ¯
                                // æ ¹æ®æ–‡æ¡£ï¼ŒOpenRouter åœ¨æœ€åä¸€ä¸ª SSE æ¶ˆæ¯ä¸­è¿”å› usage
                                // é€šå¸¸åœ¨ finish_reason å‡ºç°å
                                if (json.usage) {
                                    usage = json.usage;
                                    console.log('æ”¶åˆ° usage ä¿¡æ¯:', JSON.stringify(usage, null, 2));

                                    // éªŒè¯ token æ•°æ®
                                    if (usage.prompt_tokens && usage.completion_tokens) {
                                        console.log(`Token ç»Ÿè®¡ - è¾“å…¥: ${usage.prompt_tokens}, è¾“å‡º: ${usage.completion_tokens}, æ€»è®¡: ${usage.total_tokens}`);
                                    }
                                }

                                // æŸäº›æ¨¡å‹å¯èƒ½åœ¨ä¸åŒå­—æ®µè¿”å›æˆæœ¬
                                if (json.x_groq?.usage) {
                                    usage = json.x_groq.usage;
                                    console.log('ä» x_groq è·å– usage:', usage);
                                }

                                // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                                const finishReason = json.choices?.[0]?.finish_reason;
                                if (finishReason) {
                                    // æµå¼ç»“æŸ
                                }
                            } catch (e) {
                                console.error('è§£æSSEæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                }

                // å¤„ç†å¯èƒ½å‰©ä½™åœ¨ç¼“å†²åŒºçš„æœ€åæ•°æ®
                if (buffer.trim()) {
                    if (buffer.startsWith('data: ')) {
                        const data = buffer.slice(6).trim();
                        if (data !== '[DONE]' && data) {
                            try {
                                const json = JSON.parse(data);
                                if (json.usage && !usage) {
                                    usage = json.usage;
                                    console.log('ä»æœ€åç¼“å†²åŒºè·å– usage:', usage);
                                }
                            } catch (e) {
                                console.error('è§£ææœ€åç¼“å†²åŒºæ•°æ®å¤±è´¥:', e);
                            }
                        }
                    }
                    }

                    // å¦‚æœæ²¡æœ‰ usageï¼Œå°è¯•ä»å“åº”å¤´è·å–
                    if (!usage) {
                    const orUsage = responseHeaders['x-openrouter-usage'];
                    if (orUsage) {
                        try {
                            usage = JSON.parse(orUsage);
                            console.log('ä»å“åº”å¤´ x-openrouter-usage è·å– usage:', usage);
                        } catch (e) {
                            console.error('è§£æå“åº”å¤´ usage å¤±è´¥:', e);
                        }
                        }
                    }
                }  // ç»“æŸæµå¼æ¨¡å¼å¤„ç†

                // æ›´æ–°providerä¿¡æ¯
                const providerDiv = card.querySelector('.provider-info');
                if (providerDiv) {
                    // æ˜¾ç¤ºå®é™…çš„provider
                    if (actualProvider) {
                        // ç¾åŒ–provideråç§°
                        const providerNames = {
                            'azure': 'Azure',
                            'aws': 'AWS Bedrock',
                            'bedrock': 'AWS Bedrock',
                            'google': 'Google',
                            'openai': 'OpenAI',
                            'anthropic': 'Anthropic',
                            'groq': 'Groq',
                            'together': 'Together AI',
                            'deepinfra': 'DeepInfra',
                            'replicate': 'Replicate',
                            'perplexity': 'Perplexity',
                            'mistral': 'Mistral AI',
                            'cohere': 'Cohere'
                        };
                        provider = providerNames[actualProvider.toLowerCase()] || actualProvider;
                    } else {
                        // å¦‚æœæ²¡æœ‰è·å–åˆ°å®é™…providerï¼Œæ˜¾ç¤ºæ¨¡å‹æä¾›å•†
                        const modelProvider = request.model.split('/')[0];
                        const providerNames = {
                            'openai': 'OpenAI (via OR)',
                            'anthropic': 'Anthropic (via OR)',
                            'google': 'Google (via OR)',
                            'meta-llama': 'Meta (via OR)',
                            'mistralai': 'Mistral (via OR)',
                            'deepseek': 'DeepSeek (via OR)',
                            'qwen': 'Qwen (via OR)',
                            'moonshotai': 'Moonshot (via OR)'
                        };
                        provider = providerNames[modelProvider] || `${modelProvider} (via OR)`;
                    }
                    providerDiv.textContent = `Provider: ${provider}`;

                    // å¦‚æœæœ‰å“åº”headersä¸­çš„providerä¿¡æ¯ï¼Œä¹Ÿæ˜¾ç¤ºå‡ºæ¥
                    if (responseHeaders['x-provider']) {
                        providerDiv.textContent = `Provider: ${responseHeaders['x-provider']}`;
                    }
                }

                const endTime = Date.now();
                const duration = (endTime - startTime) / 1000;

                // å¦‚æœæœ‰ generation IDï¼Œå°è¯•è·å–å‡†ç¡®çš„ native_tokens
                if (generationId && !usage?.native_tokens_prompt) {
                    console.log('ç­‰å¾… 500ms åæŸ¥è¯¢ native_tokens...');
                    await new Promise(resolve => setTimeout(resolve, 500));

                    try {
                        const genResponse = await fetch(`https://openrouter.ai/api/v1/generation?id=${generationId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${getApiKey()}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (genResponse.ok) {
                            const genData = await genResponse.json();
                            console.log('Generation API å“åº”:', genData);

                            // æ›´æ–° usage ä¿¡æ¯
                            if (genData.data) {
                                const gen = genData.data;
                                if (gen.native_tokens_prompt || gen.native_tokens_completion) {
                                    console.log('è·å–åˆ° native_tokens:');
                                    console.log('  native_tokens_prompt:', gen.native_tokens_prompt);
                                    console.log('  native_tokens_completion:', gen.native_tokens_completion);

                                    // æ›´æ–° usage å¯¹è±¡
                                    if (!usage) usage = {};
                                    usage.native_tokens_prompt = gen.native_tokens_prompt;
                                    usage.native_tokens_completion = gen.native_tokens_completion;
                                    usage.total_cost = gen.total_cost; // å‡†ç¡®çš„æˆæœ¬

                                    // å¦‚æœä¹‹å‰æ²¡æœ‰ costï¼Œä½¿ç”¨ total_cost
                                    if (!usage.cost && gen.total_cost) {
                                        usage.cost = gen.total_cost;
                                    }
                                }
                            }
                        } else {
                            console.warn('æ— æ³•è·å– generation ä¿¡æ¯:', genResponse.status);
                        }
                    } catch (error) {
                        console.error('æŸ¥è¯¢ generation å¤±è´¥:', error);
                    }
                }

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const statsDiv = card.querySelector('.card-stats');
                if (statsDiv) {
                    if (usage) {
                        // ä¼˜å…ˆä½¿ç”¨ native_tokensï¼ˆæ›´å‡†ç¡®ï¼‰
                        const promptTokens = usage.native_tokens_prompt || usage.prompt_tokens || 0;
                        const completionTokens = usage.native_tokens_completion || usage.completion_tokens || 0;
                        const totalTokens = usage.total_tokens || (promptTokens + completionTokens);
                        const isNative = usage.native_tokens_prompt || usage.native_tokens_completion;

                        // æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æˆæœ¬æ•°æ®
                        let actualCost = null;

                        // æ ¹æ® OpenRouter æ–‡æ¡£ï¼š
                        // 1. cost å­—æ®µå•ä½æ˜¯ credits
                        // 2. 1 credit = 1 USDï¼ˆç¾å…ƒï¼‰
                        // 3. è¿”å›çš„ token æ•°é‡å¯èƒ½ä¸å‡†ç¡®ï¼ˆè§ Reddit è¯´æ˜ï¼‰
                        if (typeof usage.cost === 'number' && usage.cost >= 0) {
                            actualCost = usage.cost; // Creditsï¼Œä½† 1 credit = $1

                            // è¯¦ç»†çš„æˆæœ¬è°ƒè¯•ä¿¡æ¯
                            console.log('=== æˆæœ¬è®¡ç®—è¯¦æƒ… ===');
                            console.log('æ¨¡å‹:', request.model);
                            if (isNative) {
                                console.log('ä½¿ç”¨ Native Tokensï¼ˆå‡†ç¡®ï¼‰:');
                            } else {
                                console.log('ä½¿ç”¨ API è¿”å›çš„ tokensï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰:');
                            }
                            console.log('  è¾“å…¥:', promptTokens, isNative ? '(native)' : '');
                            console.log('  è¾“å‡º:', completionTokens, isNative ? '(native)' : '');
                            console.log('  æ€»è®¡:', totalTokens);
                            console.log('å®é™…æ”¶è´¹:', actualCost, 'USD');

                            // å¦‚æœä½¿ç”¨ native_tokensï¼Œè®¡ç®—åº”è¯¥æ›´å‡†ç¡®
                            if (request.model.includes('deepseek')) {
                                const expectedInputCost = (promptTokens / 1000000) * 0.14;
                                const expectedOutputCost = (completionTokens / 1000000) * 0.28;
                                const expectedTotal = expectedInputCost + expectedOutputCost;

                                if (isNative) {
                                    console.log('åŸºäº Native Tokens çš„æˆæœ¬è®¡ç®—:');
                                } else {
                                    console.log('ç†è®ºæˆæœ¬ï¼ˆåŸºäºæ˜¾ç¤ºçš„ token æ•°ï¼‰:');
                                }
                                console.log('  è¾“å…¥: $', expectedInputCost.toFixed(8));
                                console.log('  è¾“å‡º: $', expectedOutputCost.toFixed(8));
                                console.log('  è®¡ç®—æ€»è®¡: $', expectedTotal.toFixed(8));

                                const ratio = actualCost / expectedTotal;
                                console.log('å®é™…æ”¶è´¹/è®¡ç®—å€¼:', ratio.toFixed(2), 'å€');

                                if (!isNative && ratio > 2) {
                                    console.log('âš ï¸ è´¹ç”¨å·®å¼‚è¾ƒå¤§ï¼ŒåŸå› å¯èƒ½æ˜¯ï¼š');
                                    console.log('1. API è¿”å›çš„ token æ•°é‡ä¸å‡†ç¡®ï¼ˆéœ€è¦ native_tokensï¼‰');
                                    console.log('2. åŒ…å« OpenRouter æœåŠ¡è´¹');
                                    console.log('3. è·¯ç”±åˆ°çš„æä¾›å•†ä»·æ ¼ä¸åŒ');
                                    console.log('ğŸ’¡ ç³»ç»Ÿæ­£åœ¨å°è¯•è·å–å‡†ç¡®çš„ native_tokens...');
                                } else if (isNative && Math.abs(ratio - 1) > 0.1) {
                                    console.log('âš ï¸ å³ä½¿ä½¿ç”¨ native_tokensï¼Œä»æœ‰å·®å¼‚ï¼š');
                                    console.log('å¯èƒ½æ˜¯ OpenRouter çš„æœåŠ¡è´¹æˆ–è·¯ç”±å·®å¼‚');
                                }
                            }

                            // æ£€æŸ¥æ˜¯å¦æœ‰æ›´è¯¦ç»†çš„æˆæœ¬ä¿¡æ¯
                            if (usage.cost_details?.upstream_inference_cost) {
                                console.log('ä¸Šæ¸¸æä¾›å•†æˆæœ¬:', usage.cost_details.upstream_inference_cost);
                            }
                            console.log('==================');
                        }

                        // è°ƒè¯•ï¼šæ‰“å°å®Œæ•´çš„ usage å¯¹è±¡
                        console.log('å®Œæ•´ usage å¯¹è±¡:', JSON.stringify(usage, null, 2));

                        // é‡è¦æç¤ºï¼šä¸åŒæ¨¡å‹ä½¿ç”¨ä¸åŒçš„ tokenizer
                        // å› æ­¤åŒæ ·çš„æ–‡æœ¬åœ¨ä¸åŒæ¨¡å‹ä¸­çš„ token æ•°é‡ä¼šä¸åŒ
                        console.log(`æ¨¡å‹ ${request.model} ä½¿ç”¨å…¶åŸç”Ÿ tokenizer è®¡ç®— tokens`);

                        // æ ¼å¼åŒ–æˆæœ¬æ˜¾ç¤º
                        const formatCost = (cost) => {
                            // OpenRouter è¿”å›çš„ cost å­—æ®µæ˜¯ credits
                            // 1 credit = 1 USD

                            if (cost === 0) return '$0.0000';

                            // å§‹ç»ˆæ˜¾ç¤ºä¸ºç¾å…ƒï¼Œä¿ç•™è¶³å¤Ÿçš„å°æ•°ä½
                            if (cost < 0.01) {
                                // å°é¢è´¹ç”¨æ˜¾ç¤º 6-8 ä½å°æ•°
                                return `$${cost.toFixed(8).replace(/\.?0+$/, '')}`;
                            } else if (cost < 1) {
                                // ä¸­ç­‰è´¹ç”¨æ˜¾ç¤º 4-6 ä½å°æ•°
                                return `$${cost.toFixed(6).replace(/\.?0+$/, '')}`;
                            } else {
                                // å¤§é¢è´¹ç”¨æ˜¾ç¤º 2-4 ä½å°æ•°
                                return `$${cost.toFixed(4)}`;
                            }
                        };

                        // åªæœ‰å½“æœ‰å®é™…æˆæœ¬æ—¶æ‰æ˜¾ç¤ºè´¹ç”¨
                        const costDisplay = actualCost !== null
                            ? `<span class="stat-value" style="color: #4CAF50;">${formatCost(actualCost)}</span>`
                            : `<span class="stat-value" style="opacity: 0.5;">--</span>`;

                        statsDiv.innerHTML = `
                            <div class="stat-item">
                                <span class="stat-label">è¾“å…¥${isNative ? '*' : ''}</span>
                                <span class="stat-value" title="${promptTokens.toLocaleString()} ${isNative ? 'native' : ''} tokens">${promptTokens.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è¾“å‡º${isNative ? '*' : ''}</span>
                                <span class="stat-value" title="${completionTokens.toLocaleString()} ${isNative ? 'native' : ''} tokens">${completionTokens.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">æ€»è®¡${isNative ? '*' : ''}</span>
                                <span class="stat-value" title="${totalTokens.toLocaleString()} ${isNative ? 'native' : ''} tokens">${totalTokens.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è€—æ—¶</span>
                                <span class="stat-value">${duration.toFixed(1)}s</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">é€Ÿåº¦</span>
                                <span class="stat-value">${Math.round(completionTokens / duration)}t/s</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è´¹ç”¨</span>
                                ${costDisplay}
                            </div>
                        `;

                        // åªæœ‰å½“æœ‰å®é™…æˆæœ¬æ—¶æ‰ç´¯åŠ 
                        if (actualCost !== null) {
                            requestStats.totalCost += actualCost;
                            console.log(`è¯·æ±‚ #${request.index + 1} - å®é™…è´¹ç”¨: ${formatCost(actualCost)}`, usage);
                        } else {
                            console.log(`è¯·æ±‚ #${request.index + 1} - æ— è´¹ç”¨ä¿¡æ¯`, usage);
                        }
                    } else {
                        // æ²¡æœ‰ usage ä¿¡æ¯æ—¶çš„æ˜¾ç¤º
                        // è®¡ç®—å“åº”å­—ç¬¦æ•°å’Œé€Ÿåº¦
                        const responseChars = content.length;
                        const charsPerSecond = Math.round(responseChars / duration);

                        statsDiv.innerHTML = `
                            <div class="stat-item">
                                <span class="stat-label">å­—ç¬¦æ•°</span>
                                <span class="stat-value" title="${responseChars.toLocaleString()} ä¸ªå­—ç¬¦">${responseChars.toLocaleString()}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è€—æ—¶</span>
                                <span class="stat-value">${duration.toFixed(1)}s</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">é€Ÿåº¦</span>
                                <span class="stat-value">${charsPerSecond}c/s</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Tokens</span>
                                <span class="stat-value" style="opacity: 0.5;">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">è´¹ç”¨</span>
                                <span class="stat-value" style="opacity: 0.5;">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">çŠ¶æ€</span>
                                <span class="stat-value" style="color: #ffc107; font-size: 10px;">æ— è®¡é‡</span>
                            </div>
                        `;

                        console.warn(`è¯·æ±‚ #${request.index + 1} - æ—  usage ä¿¡æ¯`);
                        console.log(`å¯èƒ½åŸå› ï¼š
1. API æœªæ­£ç¡®è¿”å› usage ä¿¡æ¯
2. æµå¼å“åº”ä¸­ usage ä¿¡æ¯åœ¨æœ€åä¸€ä¸ª chunkï¼Œå¯èƒ½è¢«æˆªæ–­
3. æŸäº›æ¨¡å‹å¯èƒ½ä¸æ”¯æŒ token è®¡é‡
4. å»ºè®®å°è¯•éæµå¼æ¨¡å¼ä»¥è·å¾—æ›´å¯é çš„ usage ä¿¡æ¯`);
                    }
                }

                requestStats.success++;
                requestStats.times.push(duration);

                // æ£€æŸ¥æ˜¯å¦ä¸ºä¸å®Œæ•´å“åº”
                if (contentDiv.getAttribute('data-incomplete') === 'true') {
                    updateCardStatus(card, 'completed');
                    // ç»Ÿè®¡ä¸å®Œæ•´å“åº”
                    requestStats.incomplete++;

                    // æ·»åŠ è­¦å‘Šæ ‡è®°
                    const statusBadge = card.querySelector('.status-badge');
                    statusBadge.innerHTML = 'âš ï¸ éƒ¨åˆ†å®Œæˆ';
                    statusBadge.style.background = 'rgba(255, 193, 7, 0.2)';
                    statusBadge.style.color = '#ffc107';

                    // åœ¨å†…å®¹å‰æ·»åŠ æç¤º
                    contentDiv.innerHTML = `<div style="background: rgba(255, 193, 7, 0.1); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 11px; border: 1px solid rgba(255, 193, 7, 0.3);">
                        âš ï¸ æ­¤å“åº”ä¸å®Œæ•´ï¼ˆè¿æ¥ä¸­æ–­ï¼‰
                    </div>` + contentDiv.innerHTML;
                } else {
                    updateCardStatus(card, 'completed');
                }

            } catch (error) {
                console.error('Request failed:', error);

                // æ£€æµ‹æ˜¯å¦ä¸º HTTP/2 åè®®é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯
                const isNetworkError = error.message.includes('network') ||
                                      error.message.includes('ERR_HTTP2') ||
                                      error.message.includes('fetch') ||
                                      error.name === 'TypeError';

                const isRetryableError = isNetworkError ||
                                        error.message.includes('timeout') ||
                                        error.message.includes('aborted');

                // è·å–é‡è¯•æ¬¡æ•°
                const currentRetries = request.retryCount || 0;
                const MAX_RETRIES = 2;

                if (isRetryableError && currentRetries < MAX_RETRIES) {
                    // è®¡ç®—é€€é¿å»¶è¿Ÿï¼š1ç§’ã€2ç§’ã€4ç§’
                    const backoffDelay = Math.pow(2, currentRetries) * 1000;

                    // ç»Ÿè®¡é‡è¯•æ¬¡æ•°
                    requestStats.retries++;
                    updateStats();

                    console.warn(`ğŸ”„ è¯·æ±‚å¤±è´¥ï¼ˆç¬¬ ${currentRetries + 1} æ¬¡ï¼‰ï¼Œ${backoffDelay/1000} ç§’åé‡è¯•...`, error.message);

                    // æ›´æ–°å¡ç‰‡æ˜¾ç¤ºé‡è¯•çŠ¶æ€
                    const statusBadge = card.querySelector('.status-badge');
                    statusBadge.className = 'status-badge status-waiting';
                    statusBadge.textContent = `é‡è¯•ä¸­ (${currentRetries + 1}/${MAX_RETRIES})`;

                    // å»¶è¿Ÿåé‡è¯•
                    await new Promise(resolve => setTimeout(resolve, backoffDelay));

                    // å¢åŠ é‡è¯•è®¡æ•°å¹¶é‡æ–°å¤„ç†
                    request.retryCount = currentRetries + 1;
                    return processRequest(request);
                } else {
                    // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æˆ–éå¯é‡è¯•é”™è¯¯
                    requestStats.failed++;
                    updateCardStatus(card, 'error', error.message);

                    // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    let errorHtml = `<div class="error-details">`;
                    if (error.message.includes('ERR_HTTP2') || error.message.includes('network')) {
                        errorHtml += `<strong>ç½‘ç»œåè®®é”™è¯¯</strong><br>`;
                        errorHtml += `é”™è¯¯: ${error.message}<br>`;
                        errorHtml += `<small>å¯èƒ½åŸå› ï¼š<br>`;
                        errorHtml += `â€¢ OpenRouter æœåŠ¡å™¨è¿æ¥ä¸­æ–­<br>`;
                        errorHtml += `â€¢ HTTP/2 åè®®å¼‚å¸¸<br>`;
                        errorHtml += `â€¢ ç½‘ç»œä¸ç¨³å®š<br>`;
                        errorHtml += `å»ºè®®ï¼šå‡å°‘å¹¶å‘æ•°æˆ–åˆ‡æ¢åˆ°éæµå¼æ¨¡å¼</small>`;
                    } else {
                        errorHtml += `é”™è¯¯: ${error.message}`;
                    }
                    errorHtml += `</div>`;

                    contentDiv.innerHTML = errorHtml;
                }
            } finally {
                activeRequests.delete(request.id);
                updateStats();
                updateProgress();

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯·æ±‚éƒ½å®Œæˆ
                if (requestStats.success + requestStats.failed >= requestStats.total) {
                    completeAllRequests();
                }
            }
        }

        // åˆ›å»ºç»“æœå¡ç‰‡
        function createResultCard(request) {
            const card = document.createElement('div');
            card.className = 'result-card';
            card.id = request.id;

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-header-row">
                        <div class="card-info">
                            <div class="model-name" title="${request.model}">${request.model.split('/')[1] || request.model}</div>
                            <div class="provider-info">Provider: è·¯ç”±ä¸­...</div>
                        </div>
                        <div class="status-badge status-waiting">ç­‰å¾…ä¸­</div>
                    </div>
                </div>
                <div class="card-content"></div>
                <div class="card-stats"></div>
                <div class="card-actions">
                    <button class="card-btn card-btn-primary" onclick="viewFullContent('${request.id}')" title="å…¨å±æŸ¥çœ‹">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5 5h5V3H3v7h2V5zm14 0h-5V3h7v7h-2V5zM5 19h5v2H3v-7h2v5zm14 0v-5h2v7h-7v-2h5z"/>
                        </svg>
                    </button>
                    <button class="card-btn card-btn-secondary" onclick="copyContent('${request.id}')" title="å¤åˆ¶å†…å®¹">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                    </button>
                    <button class="card-btn card-btn-secondary" onclick="debugRequest('${request.id}')" title="è°ƒè¯•ä¿¡æ¯">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2zm-4 10H4V5h14v14z"/>
                        </svg>
                    </button>
                </div>
            `;

            return card;
        }

        // æ›´æ–°å¡ç‰‡çŠ¶æ€
        function updateCardStatus(card, status, error = null) {
            const statusBadge = card.querySelector('.status-badge');
            statusBadge.className = `status-badge status-${status}`;

            const statusText = {
                waiting: 'ç­‰å¾…ä¸­',
                generating: 'ç”Ÿæˆä¸­',
                completed: 'å·²å®Œæˆ',
                error: 'å‡ºé”™äº†'
            };

            statusBadge.textContent = statusText[status];

            if (status === 'generating') {
                statusBadge.innerHTML = 'ç”Ÿæˆä¸­ <span class="loading-spinner"></span>';
            }

            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ - ä½¿ç”¨ç±»è€Œä¸æ˜¯style,é¿å…æ”¹å˜å¡ç‰‡é«˜åº¦
            if (status === 'completed') {
                const statsDiv = card.querySelector('.card-stats');
                if (statsDiv) {
                    statsDiv.classList.add('visible'); // æ·»åŠ visibleç±»,è§¦å‘æ·¡å…¥
                }
            }

            if (error) {
                card.setAttribute('data-error', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('totalRequests').textContent = requestStats.total;
            document.getElementById('successRequests').textContent = requestStats.success;
            document.getElementById('failedRequests').textContent = requestStats.failed;
            document.getElementById('activeRequests').textContent = activeRequests.size;

            if (requestStats.times.length > 0) {
                const avgTime = requestStats.times.reduce((a, b) => a + b, 0) / requestStats.times.length;
                document.getElementById('avgTime').textContent = `${avgTime.toFixed(1)}s`;
            }

            // æ›´æ–°æ€»è´¹ç”¨æ˜¾ç¤º - åªæ˜¾ç¤ºå®é™…å€¼ï¼ˆç¾å…ƒï¼‰
            const formatTotalCost = (cost) => {
                if (cost === 0) return '$0.0000';

                // å§‹ç»ˆæ˜¾ç¤ºä¸ºç¾å…ƒ
                if (cost < 0.01) {
                    return `$${cost.toFixed(6).replace(/\.?0+$/, '')}`;
                } else if (cost < 1) {
                    return `$${cost.toFixed(4).replace(/\.?0+$/, '')}`;
                } else {
                    return `$${cost.toFixed(2)}`;
                }
            };
            document.getElementById('totalCostStat').textContent = formatTotalCost(requestStats.totalCost);
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const completed = requestStats.success + requestStats.failed;
            const progress = (completed / requestStats.total) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        // å®Œæˆæ‰€æœ‰è¯·æ±‚
        function completeAllRequests() {
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            // è¾“å‡ºè¯¦ç»†ç»Ÿè®¡
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“Š æ‰¹é‡æµ‹è¯•å®Œæˆç»Ÿè®¡:');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`âœ… æˆåŠŸ: ${requestStats.success} / ${requestStats.total}`);
            console.log(`âŒ å¤±è´¥: ${requestStats.failed} / ${requestStats.total}`);
            console.log(`ğŸ”„ é‡è¯•æ¬¡æ•°: ${requestStats.retries}`);
            console.log(`âš ï¸  ä¸å®Œæ•´å“åº”: ${requestStats.incomplete}`);
            console.log(`ğŸ’° æ€»è´¹ç”¨: $${requestStats.totalCost.toFixed(6)}`);
            if (requestStats.times.length > 0) {
                const avgTime = requestStats.times.reduce((a, b) => a + b, 0) / requestStats.times.length;
                console.log(`â±ï¸  å¹³å‡è€—æ—¶: ${avgTime.toFixed(2)}s`);
            }
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

            if (requestStats.retries > 0) {
                console.warn(`âš ï¸  æ³¨æ„: æœ‰ ${requestStats.retries} æ¬¡è¯·æ±‚é‡è¯•ï¼ˆåŸå§‹é”™è¯¯è¢«è‡ªåŠ¨ä¿®å¤ï¼‰`);
            }
            if (requestStats.incomplete > 0) {
                console.warn(`âš ï¸  æ³¨æ„: æœ‰ ${requestStats.incomplete} ä¸ªå“åº”ä¸å®Œæ•´ï¼ˆè¿æ¥ä¸­æ–­ï¼‰`);
            }

            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
            }, 2000);
        }

        // åœæ­¢æ‰€æœ‰è¯·æ±‚
        function stopAllRequests() {
            isRunning = false;
            activeRequests.clear();
            completeAllRequests();
        }

        // æŸ¥çœ‹å®Œæ•´å†…å®¹
        function viewFullContent(cardId) {
            const card = document.getElementById(cardId);
            const contentDiv = card.querySelector('.card-content');
            const rawContent = contentDiv.getAttribute('data-raw-content') || contentDiv.textContent;
            const modelName = card.querySelector('.model-name').textContent;

            document.getElementById('modalTitle').textContent = `${modelName} - å“åº”è¯¦æƒ…`;
            const modalContent = document.getElementById('modalContent');
            
            // é»˜è®¤æ˜¾ç¤ºåŸå§‹å†…å®¹
            modalContent.textContent = rawContent;
            modalContent.setAttribute('data-raw-content', rawContent);
            modalContent.className = 'raw-view';
            
            // é‡ç½®åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.view-toggle-btn:first-child').classList.add('active');
            
            document.getElementById('viewModal').style.display = 'block';
        }

        // åˆ‡æ¢æ¨¡æ€æ¡†è§†å›¾
        async function toggleModalView(mode) {
            const modalContent = document.getElementById('modalContent');
            const rawContent = modalContent.getAttribute('data-raw-content') || '';

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            if (mode === 'raw') {
                // æ˜¾ç¤ºåŸå§‹å†…å®¹
                modalContent.textContent = rawContent;
                modalContent.className = 'raw-view';
            } else if (mode === 'markdown') {
                // æ¸²æŸ“ Markdown
                modalContent.className = '';
                await renderMarkdown(modalContent, rawContent);
            } else if (mode === 'html') {
                // æ¸²æŸ“ HTML é¢„è§ˆ
                modalContent.className = 'html-preview';
                renderHtmlPreview(modalContent, rawContent);
            }
        }

        // ä»å†…å®¹ä¸­æå– HTML
        function extractHtml(content) {
            // å°è¯•ä»å„ç§æ ¼å¼ä¸­æå–å®Œæ•´çš„ HTML
            let html = null;

            // å°è¯•åŒ¹é… Markdown ä»£ç å—ä¸­çš„ HTML
            const codeBlockPatterns = [
                /```html\s*([\s\S]*?)```/i,
                /```HTML\s*([\s\S]*?)```/,
                /```\s*(<!DOCTYPE html[\s\S]*?)<\/html>\s*```/i
            ];

            for (const pattern of codeBlockPatterns) {
                const match = content.match(pattern);
                if (match) {
                    html = match[1];
                    break;
                }
            }

            // å¦‚æœä»£ç å—ä¸­æ²¡æ‰¾åˆ°ï¼Œå°è¯•ç›´æ¥ä»å†…å®¹ä¸­æå–
            if (!html) {
                const directMatch = content.match(/(<!DOCTYPE html[\s\S]*?<\/html>)/i);
                if (directMatch) {
                    html = directMatch[1];
                }
            }

            // éªŒè¯æ˜¯å¦ä¸ºå®Œæ•´çš„ HTML
            if (html) {
                const hasDoctype = /<!DOCTYPE\s+html/i.test(html);
                const hasHtmlEnd = /<\/html>/i.test(html);

                if (hasDoctype && hasHtmlEnd) {
                    return html;
                }
            }

            // å¦‚æœä¸æ˜¯å®Œæ•´çš„ HTMLï¼Œè¿”å› null
            return null;
        }

        // æ£€æµ‹ HTML æ˜¯å¦æˆªæ–­
        function isHtmlTruncated(html) {
            const trimmed = html.trim();

            // æ£€æŸ¥å¸¸è§çš„æˆªæ–­æ¨¡å¼
            const truncationIndicators = [
                // æœªé—­åˆçš„æ ‡ç­¾(ç®€å•æ£€æµ‹)
                /<[a-z]+[^>]*$/i,
                // Markdown ä»£ç å—æœªé—­åˆ
                /```\s*$/,
                // æ˜æ˜¾çš„æˆªæ–­æ ‡è®°
                /\.{3,}\s*$/,
                /\[truncated\]/i,
                /\[è¢«æˆªæ–­\]/,
            ];

            for (const pattern of truncationIndicators) {
                if (pattern.test(trimmed)) {
                    return true;
                }
            }

            // æ£€æŸ¥ HTML æ ‡ç­¾æ˜¯å¦å¹³è¡¡
            const openTags = (html.match(/<([a-z]+)(?:\s|>)/gi) || [])
                .map(tag => tag.match(/<([a-z]+)/i)[1].toLowerCase())
                .filter(tag => !['br', 'hr', 'img', 'input', 'meta', 'link'].includes(tag));

            const closeTags = (html.match(/<\/([a-z]+)>/gi) || [])
                .map(tag => tag.match(/<\/([a-z]+)>/i)[1].toLowerCase());

            // ç®€å•çš„æ ‡ç­¾å¹³è¡¡æ£€æŸ¥
            if (openTags.length !== closeTags.length) {
                return true;
            }

            return false;
        }

        // å°è¯•ä¿®å¤æˆªæ–­çš„ HTML
        function repairHtml(html) {
            let repaired = html.trim();

            // ç§»é™¤æœ«å°¾ä¸å®Œæ•´çš„æ ‡ç­¾
            repaired = repaired.replace(/<[a-z]+[^>]*$/i, '');

            // ç§»é™¤æœªé—­åˆçš„ Markdown ä»£ç å—æ ‡è®°
            repaired = repaired.replace(/```\s*$/, '');

            // å°è¯•é—­åˆåŸºæœ¬çš„ HTML ç»“æ„
            const needsHtmlClose = /<html[\s\S]*>/i.test(repaired) && !/<\/html>/i.test(repaired);
            const needsBodyClose = /<body[\s\S]*>/i.test(repaired) && !/<\/body>/i.test(repaired);
            const needsHeadClose = /<head[\s\S]*>/i.test(repaired) && !/<\/head>/i.test(repaired);

            if (needsHeadClose) repaired += '\n</head>';
            if (needsBodyClose) repaired += '\n</body>';
            if (needsHtmlClose) repaired += '\n</html>';

            return repaired;
        }

        // æ¸²æŸ“ HTML é¢„è§ˆ
        function renderHtmlPreview(container, content) {
            container.innerHTML = '';

            // æå– HTML
            const extractedHtml = extractHtml(content);

            if (!extractedHtml) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-bottom: 16px;">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        <p>HTML ä¸å®Œæ•´</p>
                        <p style="font-size: 12px; margin-top: 8px;">å†…å®¹ä¸­æ²¡æœ‰æ‰¾åˆ°å®Œæ•´çš„ HTML ä»£ç ï¼ˆç¼ºå°‘ &lt;!DOCTYPE html&gt; æˆ– &lt;/html&gt; æ ‡ç­¾ï¼‰</p>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            const infoWarning = document.createElement('div');
            infoWarning.className = 'html-preview-warning';
            infoWarning.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <span>å†…éƒ¨æµ‹è¯•ç¯å¢ƒï¼šå®Œæ•´ HTML é¢„è§ˆï¼Œæ”¯æŒ JavaScriptã€å¤–éƒ¨èµ„æºå’Œè·¨åŸŸè¯·æ±‚ã€‚</span>
            `;
            container.appendChild(infoWarning);

            // åˆ›å»º iframe é¢„è§ˆï¼ˆå®Œå…¨æ— é™åˆ¶ï¼‰
            const iframe = document.createElement('iframe');
            // ç§»é™¤ sandbox é™åˆ¶ï¼Œå…è®¸æ‰€æœ‰åŠŸèƒ½
            iframe.style.width = '100%';
            iframe.style.minHeight = '500px';
            iframe.style.border = 'none';
            iframe.style.background = 'white';

            container.appendChild(iframe);

            // å†™å…¥ HTML å†…å®¹
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(extractedHtml);
            iframeDoc.close();

            // è°ƒæ•´ iframe é«˜åº¦ä»¥é€‚åº”å†…å®¹
            setTimeout(() => {
                try {
                    const height = iframeDoc.body.scrollHeight;
                    iframe.style.height = Math.max(height + 20, 500) + 'px';
                } catch (e) {
                    console.warn('æ— æ³•è°ƒæ•´ iframe é«˜åº¦:', e);
                }
            }, 100);
        }

        // å¤åˆ¶å†…å®¹
        function copyContent(cardId) {
            const card = document.getElementById(cardId);
            const contentDiv = card.querySelector('.card-content');
            const rawContent = contentDiv.getAttribute('data-raw-content') || contentDiv.textContent;

            navigator.clipboard.writeText(rawContent).then(() => {
                showToast('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å†…å®¹å¤åˆ¶');
            });
        }

        // è°ƒè¯•è¯·æ±‚
        function debugRequest(cardId) {
            const card = document.getElementById(cardId);
            const error = card.getAttribute('data-error');
            const modelName = card.querySelector('.model-name').textContent;

            if (error) {
                alert(`æ¨¡å‹: ${modelName}\né”™è¯¯ä¿¡æ¯: ${error}`);
            } else {
                alert(`æ¨¡å‹: ${modelName}\nçŠ¶æ€: æ­£å¸¸`);
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('viewModal').style.display = 'none';
        }

        // ============================================
        // AI ç”Ÿå›¾åŠŸèƒ½
        // ============================================

        // Together AI API Key ç®¡ç†
        function getTogetherApiKey() {
            return localStorage.getItem('together_api_key') || '';
        }

        function saveTogetherApiKey() {
            const input = document.getElementById('togetherApiKeyInput');
            const key = input.value.trim();

            if (!key) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ API Key');
                return;
            }

            localStorage.setItem('together_api_key', key);
            updateTogetherApiKeyStatus();
            showToast('Together AI API Key å·²ä¿å­˜');
        }

        function clearTogetherApiKey() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤å·²ä¿å­˜çš„ Together AI API Key å—ï¼Ÿ')) {
                return;
            }

            localStorage.removeItem('together_api_key');
            document.getElementById('togetherApiKeyInput').value = '';
            updateTogetherApiKeyStatus();
            showToast('Together AI API Key å·²æ¸…é™¤');
        }

        function updateTogetherApiKeyStatus() {
            const key = getTogetherApiKey();
            const section = document.getElementById('togetherApiKeySection');
            const badge = document.getElementById('togetherApiKeyBadge');
            const badgeText = document.getElementById('togetherApiKeyBadgeText');
            const status = document.getElementById('togetherApiKeyStatus');
            const input = document.getElementById('togetherApiKeyInput');

            if (key) {
                // éšè—é…ç½®åŒºåŸŸï¼Œæ˜¾ç¤ºå¾½ç« 
                section.classList.add('hidden');
                badge.style.display = 'inline-flex';
                badgeText.textContent = `${key.substring(0, 12)}...${key.substring(key.length - 4)}`;
                input.value = key;
            } else {
                // æ˜¾ç¤ºé…ç½®åŒºåŸŸï¼Œéšè—å¾½ç« 
                section.classList.remove('hidden');
                badge.style.display = 'none';
            }
        }

        // ç¼–è¾‘ Together AI API Key
        function editTogetherApiKey() {
            const section = document.getElementById('togetherApiKeySection');
            section.classList.remove('hidden');
            document.getElementById('togetherApiKeyInput').focus();

            // éšè—å¾½ç« 
            document.getElementById('togetherApiKeyBadge').style.display = 'none';
        }

        // æ‰“å¼€/å…³é—­AIç”Ÿå›¾Modal
        function openImageGenModal() {
            document.getElementById('imageGenModal').style.display = 'block';
            updateTogetherApiKeyStatus();
        }

        function closeImageGenModal() {
            document.getElementById('imageGenModal').style.display = 'none';
        }

        // ç”Ÿæˆå›¾ç‰‡
        async function generateImages() {
            const apiKey = getTogetherApiKey();
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® Together AI API Key');
                document.getElementById('togetherApiKeyInput').focus();
                return;
            }

            const prompt = document.getElementById('imagePromptInput').value.trim();
            if (!prompt) {
                alert('è¯·è¾“å…¥å›¾ç‰‡ç”Ÿæˆæç¤ºè¯');
                return;
            }

            const generateBtn = document.getElementById('generateImageBtn');
            const statusDiv = document.getElementById('imageGenStatus');
            const gridDiv = document.getElementById('generatedImagesGrid');

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                generateBtn.disabled = true;
                statusDiv.style.display = 'block';
                gridDiv.innerHTML = '';

                // è°ƒç”¨ Together AI API
                const response = await fetch('https://api.together.xyz/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'black-forest-labs/FLUX.1-schnell',
                        prompt: prompt,
                        steps: 10,
                        n: 4,
                        width: 1024,
                        height: 1024
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'ç”Ÿæˆå›¾ç‰‡å¤±è´¥');
                }

                const data = await response.json();

                // éšè—åŠ è½½çŠ¶æ€
                statusDiv.style.display = 'none';

                // æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡
                if (data.data && data.data.length > 0) {
                    data.data.forEach((item, index) => {
                        const imageUrl = item.url || (item.b64_json ? `data:image/png;base64,${item.b64_json}` : null);
                        if (imageUrl) {
                            const imageItem = document.createElement('div');
                            imageItem.className = 'generated-image-item';
                            imageItem.innerHTML = `
                                <img src="${imageUrl}" alt="ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}" onclick="openImagePreview('${imageUrl}')">
                                <div class="image-actions">
                                    <button class="image-action-btn" onclick="downloadImage('${imageUrl}', 'ç”Ÿæˆå›¾ç‰‡_${index + 1}.png')">ä¸‹è½½</button>
                                </div>
                            `;
                            gridDiv.appendChild(imageItem);
                        }
                    });
                    showToast('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼');
                } else {
                    throw new Error('æœªè¿”å›å›¾ç‰‡æ•°æ®');
                }

            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                alert(`ç”Ÿæˆå›¾ç‰‡å¤±è´¥: ${error.message}`);
                statusDiv.style.display = 'none';
            } finally {
                generateBtn.disabled = false;
            }
        }

        // ä¸‹è½½å›¾ç‰‡
        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);

                showToast('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼');
            } catch (error) {
                console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', error);
                alert('ä¸‹è½½å›¾ç‰‡å¤±è´¥ï¼Œè¯·å³é”®å›¾ç‰‡å¦å­˜ä¸º');
            }
        }

        // æ‰“å¼€å›¾ç‰‡é¢„è§ˆ
        function openImagePreview(imageUrl) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('imagePreviewImg');
            img.src = imageUrl;
            modal.style.display = 'block';

            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…ç‚¹å‡»å›¾ç‰‡å…³é—­Modal
            event.stopPropagation();
        }

        // å…³é—­å›¾ç‰‡é¢„è§ˆ
        function closeImagePreview() {
            document.getElementById('imagePreviewModal').style.display = 'none';
        }


        // æ¸²æŸ“ Markdown
        async function renderMarkdown(element, content) {
            if (!element.hasAttribute('data-raw-content')) {
                element.setAttribute('data-raw-content', content);
            }
            
            // è§£æ Markdown
            let html = marked.parse(content);
            
            // å¤„ç† Mermaid ä»£ç å—
            html = html.replace(/<pre><code class="language-mermaid">([\s\S]*?)<\/code><\/pre>/g, 
                '<div class="mermaid">$1</div>');
            
            element.innerHTML = html;
            element.classList.add('markdown-body');
            
            // æ¸²æŸ“æ‰€æœ‰ Mermaid å›¾è¡¨
            const mermaidDivs = element.querySelectorAll('.mermaid');
            if (mermaidDivs.length > 0) {
                try {
                    await mermaid.run({
                        nodes: mermaidDivs,
                        suppressErrors: true
                    });
                } catch (err) {
                    console.error('Mermaid æ¸²æŸ“å¤±è´¥:', err);
                }
            }
        }

        // ç”Ÿæˆå”¯ä¸€ID
        function generateId() {
            return 'card-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            // ç®€å•çš„æç¤ºå®ç°
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-gradient);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const viewModal = document.getElementById('viewModal');
            const imageGenModal = document.getElementById('imageGenModal');

            if (event.target === viewModal) {
                closeModal();
            }
            if (event.target === imageGenModal) {
                closeImageGenModal();
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeImageGenModal();
                closeImagePreview();
            }
            if (e.ctrlKey && e.key === 'Enter') {
                if (!document.getElementById('startBtn').disabled) {
                    startBatchTest();
                }
            }
        });
    </script>
</body>
</html>