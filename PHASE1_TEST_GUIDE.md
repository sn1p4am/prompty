# Prompty V2 - Phase 1 测试指南

## 📋 测试准备

### 已完成的模块

✅ **核心基础设施**
- `database-schema.sql` - PostgreSQL 数据库 schema
- `core-modules.js` - 4 个核心类
  - DatabaseManager (PGlite 数据库管理)
  - TreeSitterParser (Tree-sitter 解析器)
  - SemanticMarkerInjector (语义标记注入)
  - VersionManager (版本管理)

✅ **索引构建模块**
- `indexer-modules.js` - 3 个索引类
  - HTMLIndexer (HTML 结构索引)
  - DependencyAnalyzer (依赖关系分析)
  - IndexBuilder (索引构建协调器)

✅ **自然语言查询模块**
- `nlp-query-engine.js` - 3 个查询类
  - NaturalLanguageQueryEngine (NLP 查询引擎)
  - MultiMatchHandler (多匹配处理器)
  - SimpleLLMClient (LLM 客户端)

✅ **测试页面**
- `test-v2.html` - 完整的测试界面，包含 7 个测试

✅ **示例文件**
- `samples/index.html` - 首页示例
- `samples/about.html` - 关于页示例
- `samples/contact.html` - 联系页示例

---

## 🚀 如何测试

### 方法 1: 直接在浏览器中打开

1. 在浏览器中打开 `test-v2.html`
2. 按顺序运行测试：

#### 测试 1: 数据库初始化
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ 创建 DatabaseManager 实例成功
  - ✅ 数据库初始化成功
  - ✅ 版本表查询成功
  - 进度条显示 100%
  - 启用后续所有测试

#### 测试 2: Tree-sitter 解析器
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ Tree-sitter 初始化成功
  - ✅ HTML 解析成功
  - 显示根节点类型

#### 测试 3: 语义标记注入
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ 注入语义标记成功
  - ✅ 提取语义标记成功
  - 显示提取的标记 JSON

#### 测试 4: 版本管理
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ 创建新版本成功
  - ✅ 获取所有版本成功
  - 显示版本 ID 和数量

#### 测试 5: 完整流程测试
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ 版本创建
  - ✅ 语义标记注入
  - ✅ 文件保存
  - ✅ 文件查询

#### 测试 6: 索引构建测试 ⭐ 新增
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ IndexBuilder 创建成功
  - ✅ 测试版本创建成功
  - ✅ 2 个文件保存成功 (index.html, about.html)
  - ✅ 索引构建完成（耗时 < 3 秒）
  - ✅ 索引统计显示：
    - 文件数: 2
    - AST 节点数: > 10
    - 语义标记数: > 0
    - 依赖关系数: > 0

#### 测试 7: 自然语言查询测试 ⭐ 新增
- 点击 "运行测试" 按钮
- 预期结果：
  - ✅ NLP 引擎创建成功
  - ✅ 查询 "找到所有导航" - 找到 2 个导航元素
  - ✅ 查询 "找到购买按钮" - 找到 1 个按钮
  - ✅ 查询 "找到所有标题" - 找到 2 个标题
  - ✅ 意图识别成功
  - 显示查询结果 JSON 和意图提取结果

---

## 📊 测试验证要点

### 数据库功能
- [x] PGlite 在浏览器中成功初始化
- [x] 数据库 schema 正确创建
- [x] 事务功能正常
- [x] 查询功能正常

### 索引功能
- [x] HTML DOM 树正确解析
- [x] AST 节点正确存储
- [x] 语义标记正确注入和提取
- [x] 依赖关系正确分析
- [x] 索引统计信息准确

### 查询功能
- [x] 自然语言意图提取正确
- [x] SQL 查询策略生成正确
- [x] 多策略查询执行成功
- [x] 结果合并和排序正确

---

## 🐛 常见问题

### 问题 1: PGlite 加载失败
**症状**: 控制台报错 "Failed to fetch"

**解决方案**:
- 确保网络连接正常（PGlite 从 CDN 加载）
- 尝试刷新页面
- 检查浏览器是否支持 WebAssembly 和 IndexedDB

### 问题 2: Tree-sitter 解析失败
**症状**: 测试 2 失败

**解决方案**:
- 检查 Tree-sitter WASM 文件是否成功加载
- 确保浏览器支持 WebAssembly

### 问题 3: 索引构建耗时过长
**症状**: 测试 6 执行超过 10 秒

**解决方案**:
- 正常情况下应该在 1-3 秒内完成
- 检查浏览器性能
- 查看控制台是否有错误信息

---

## 🎯 测试成功标准

所有 7 个测试都应该显示 **✓ 通过** 状态（绿色背景）。

如果所有测试通过，说明：
1. ✅ Phase 1 核心基础设施完全就绪
2. ✅ 数据库索引功能正常工作
3. ✅ 自然语言查询引擎正常工作
4. ✅ 可以开始 Phase 2 的开发

---

## 📝 测试结果检查清单

运行完所有测试后，请检查：

- [ ] 数据库初始化成功，进度条 100%
- [ ] Tree-sitter 解析器正常工作
- [ ] 语义标记正确注入和提取
- [ ] 版本管理功能正常
- [ ] 完整流程测试通过
- [ ] 索引构建成功，统计信息正确
- [ ] 自然语言查询找到正确元素
- [ ] 浏览器控制台无错误信息

---

## 🔍 查看详细日志

每个测试都有实时日志显示，日志颜色含义：
- 🔵 蓝色 (info): 信息
- 🟢 绿色 (success): 成功
- 🔴 红色 (error): 错误
- 🟠 橙色 (warn): 警告

---

## 📂 示例文件说明

`samples/` 目录下的三个 HTML 文件用于手动测试和演示：

### index.html
- 包含导航栏 (nav)
- 包含 CTA 按钮 (购买)
- 包含标题 (h1)
- 包含功能卡片 (feature-card)

### about.html
- 包含导航栏
- 包含团队介绍
- 包含标题

### contact.html
- 包含导航栏
- 包含联系表单
- 包含提交/重置按钮

这些文件可以用来测试：
- 多文件索引
- 跨文件依赖分析
- 自然语言查询

---

## 下一步

如果所有测试通过，接下来将进入 **Phase 2**：
1. 实现 Tree-sitter Query 支持（更精确的代码定位）
2. 集成 LLM API（OpenRouter）
3. 实现 LLM 辅助的意图提取和消歧
4. 实现批量代码修改引擎

---

**测试时间**: 预计 5-10 分钟
**测试难度**: ⭐ 简单（只需点击按钮）
